# Feature Research

**Domain:** Hugo static site CI/CD pipeline — personal blog
**Researched:** 2026-02-28
**Confidence:** HIGH (project context is concrete; research verifies current ecosystem state)

---

## Context

This is a repair milestone, not a greenfield build. The blog exists, content exists, the k8s cluster exists. The CI pipeline is broken. The repo has hygiene problems. The goal is: CI passes, repo is clean, site deploys. Nothing more.

Feature categorization is oriented around the CI/CD pipeline and repo health, not blog features.

---

## Feature Landscape

### Table Stakes (CI is broken without these)

These are the features/fixes that must exist for the core value — "CI build passes so content can be published" — to be true.

| Feature | Why Expected | Complexity | Notes |
|---------|--------------|------------|-------|
| Pin Hugo to a specific official Docker image | `debian:latest` + `apt-get install hugo` delivers Debian trixie's Hugo 0.131.0 on a good day, older on debian stable — current site requires a newer version; this is the root cause of the broken build | LOW | Use `ghcr.io/gohugoio/hugo:0.157.0` or `hugomods/hugo:latest-ext` in Dockerfile builder stage; never `apt-get install hugo` |
| Multi-stage Docker build (build + serve) | Site content is generated by Hugo; only the `/public/` output should go into the NGINX serving image; already present but uses wrong Hugo source | LOW | Pattern already in place: fix the `FROM` line, keep the multi-stage structure |
| NGINX serving stage | Standard pattern: generated static files served by NGINX; already in place with `byjg/nginx-extras` | LOW | Keep existing NGINX stage; `byjg/nginx-extras` is an old image — consider switching to `nginx:alpine` for a more maintained upstream, but not required to unblock CI |
| `.woodpecker.yml` pipeline passes | The Woodpecker pipeline runs build-image and update-deployment steps; these only work if the Docker build succeeds | LOW | Pipeline structure is already correct; fixing the Dockerfile unblocks this |
| Kubernetes deployment restart after image push | After a new image is pushed to DockerHub, the k8s deployment must be patched to pull the new image | LOW | Already implemented via `curl -X PATCH` in the update-deployment step; confirm service account token is available |
| Remove hardcoded password from repo | `hooks/build` contains `LETSENCRYPT_PASS="MGm2Sh7FYERIbsmND5y5"` in plaintext — this is a secret leak; the file must be deleted and the credential rotated | LOW | Delete `hooks/` directory entirely; that script is a local dev artifact with no CI role |
| Remove stray files from repo | `__pycache__/`, `08-nesting-openvpn-drawio.xml`, `11-hard-dist-layout.xml`, `ideas.txt` have no role in building or serving the site | LOW | Delete from repo and add patterns to `.gitignore` so they cannot re-appear |
| `.gitignore` covers build artifacts and local files | Current `.gitignore` only excludes `*.swp` and `public/` — Python cache, Hugo lock file, and OS artifacts are not excluded | LOW | Add `__pycache__/`, `*.py[cod]`, `.hugo_build.lock`, `.DS_Store`, `*.xml` (drawio), `ideas.txt` to `.gitignore` |

### Differentiators (Nice to Have, Not Required to Unblock CI)

These are features common in polished personal blog pipelines. None are needed for the immediate milestone.

| Feature | Value Proposition | Complexity | Notes |
|---------|-------------------|------------|-------|
| Pinned NGINX base image version | `byjg/nginx-extras:latest` can silently break; pinning `nginx:1.27-alpine` gives reproducible builds | LOW | Can be done in the same Dockerfile pass; low effort, real stability value |
| `auto_tag: true` with semver tags | Current pipeline produces `:latest` only; git-tag-based tagging allows rollback to specific versions | LOW | Already using `auto_tag: true` in `.woodpecker.yml` — this is already configured correctly |
| Build-time `--minify` flag for Hugo | Reduces generated HTML/CSS/JS size; free performance improvement | LOW | Add `--minify` to the `hugo` command in Dockerfile |
| Explicit `ARG HUGO_VERSION` in Dockerfile | Allows updating Hugo version without editing the FROM line; makes version bumps a one-line change | LOW | Pattern: `ARG HUGO_VERSION=0.157.0` then `FROM ghcr.io/gohugoio/hugo:${HUGO_VERSION}-ext-alpine` |
| Git submodule handling in CI clone | If theme becomes a submodule later, the Woodpecker git plugin needs `recursive: true` in clone settings | LOW | Not needed now; theme is embedded in `themes/` directory |
| `.dockerignore` tightening | Current `.dockerignore` only excludes `public/` and `.git/` — stray files (xml, pycache, ideas.txt) are copied into the Docker build context even if deleted from the repo; tightening this reduces build context size | LOW | Add `__pycache__`, `*.xml`, `ideas.txt`, `hooks/`, `.hugo_build.lock` to `.dockerignore` |
| Hugo `--printPathWarnings` in CI build | Surfaces path collision warnings that would otherwise be silent failures | LOW | Add flag to `hugo` command in Dockerfile |

### Anti-Features (Explicitly Out of Scope for This Milestone)

These are things that might seem related but would introduce unnecessary scope or risk.

| Feature | Why Requested | Why Problematic | Alternative |
|---------|---------------|-----------------|-------------|
| Hugo config migration (TOML → YAML) | YAML is Hugo's preferred format in newer versions | Not needed to fix CI; introduces risk of config parsing errors mid-repair | Leave `config.toml` as-is; migrate in a separate milestone |
| Hugo version upgrade path (latest → always latest) | Stay on newest Hugo for features | `FROM ghcr.io/gohugoio/hugo:latest` breaks reproducibility — a new Hugo release can break the build silently | Pin to a specific version like `0.157.0`; update deliberately |
| Theme update or replacement | Hugo-theme-nix is old; newer themes exist | Theme changes can break layouts, require content front matter changes, and are risky | Leave theme as-is per PROJECT.md constraints |
| Google Analytics 4 migration | UA-132992428-1 (Universal Analytics) is deprecated | UA is dead, but swapping GA IDs in `config.toml` is a content concern, not a CI concern | Separate task after CI is green |
| Multi-platform Docker builds (arm64/amd64) | Home k8s cluster might be arm | Current cluster is x86 (Proxmox, based on infra context); adds build time and complexity | Build for `linux/amd64` only; add platforms later if cluster changes |
| Caching Docker layers in Woodpecker | Speeds up repeated builds | Requires buildx cache backend configuration; adds complexity for marginal gain on a personal blog with infrequent pushes | Not worth it at this scale |
| Container image vulnerability scanning | Security best practice | Adds pipeline step, requires action on findings, creates CI friction | Add after pipeline is stable; not a blocker |
| Secrets manager integration | Proper secret storage beyond Woodpecker secrets | Current Woodpecker `from_secret` for DockerHub PAT is sufficient; a full vault integration is overengineering for a personal blog | Keep using Woodpecker repository secrets |
| LetsEncrypt cert in container | `hooks/build` suggests this was attempted | TLS at the container level is wrong for a k8s setup with ingress handling TLS termination | Keep TLS at the ingress level (already correct in `configs/kubernetes.yaml`) |

---

## Feature Dependencies

```
[Remove stray files from repo]
    └──before──> [Tighten .gitignore] (gitignore prevents recurrence)
    └──before──> [Tighten .dockerignore] (prevents stray files in build context)

[Pin Hugo to official Docker image]
    └──unblocks──> [Docker build succeeds]
                       └──unblocks──> [Woodpecker pipeline passes]
                                          └──unblocks──> [K8s deployment restarts]
                                                             └──validates──> [Site loads in browser]

[Delete hooks/ with hardcoded password]
    └──independent of──> [Docker build fix] (security fix, no build impact)
    └──rotated credential required independently]

[Tighten .dockerignore]
    └──enhances──> [Pin Hugo to official Docker image] (smaller build context = faster builds)
```

### Dependency Notes

- **Pin Hugo Docker image requires nothing else**: It is the root fix. Everything else is cleanup or polish.
- **Stray file removal is independent of the build fix**: Do both in the same pass for cleanliness, but either can be done first.
- **Credential rotation (LetsEncrypt password) is independent**: Deleting the file removes the leak from future commits; rotating the credential is an infra task separate from this repo.
- **`.gitignore` before committing deletions**: Add ignore rules before (or in the same commit as) removing the files, so the files cannot drift back in.

---

## MVP Definition

### Launch With (v1 — unblocks CI)

Minimum viable work to make the CI pipeline green and the site deployable.

- [ ] Replace `RUN apt-get install hugo` with `FROM ghcr.io/gohugoio/hugo:0.157.0-ext-alpine AS hugo` (or equivalent pinned official image) in `Dockerfile` — this is the root cause fix
- [ ] Delete `hooks/` directory (contains hardcoded password) — security fix
- [ ] Delete `__pycache__/`, `08-nesting-openvpn-drawio.xml`, `11-hard-dist-layout.xml`, `ideas.txt` — repo hygiene
- [ ] Update `.gitignore` to exclude `__pycache__/`, `*.py[cod]`, `.hugo_build.lock`, `.DS_Store` — prevents recurrence
- [ ] Verify Woodpecker pipeline passes end-to-end (build → push → k8s restart)

### Add After Validation (v1.x — polish, no regressions)

- [ ] Tighten `.dockerignore` to exclude stray file patterns — when: first post-unblock cleanup pass
- [ ] Pin NGINX base image to `nginx:1.27-alpine` instead of `byjg/nginx-extras:latest` — when: NGINX image update is convenient
- [ ] Add `--minify` to Hugo build command — when: testing confirms it doesn't break the theme

### Future Consideration (v2+ — separate milestones)

- [ ] Hugo config migration from TOML to YAML — only if Hugo deprecates TOML support
- [ ] GA4 migration — when someone wants analytics again
- [ ] Theme modernization — separate milestone, high effort, high risk

---

## Feature Prioritization Matrix

| Feature | User Value | Implementation Cost | Priority |
|---------|------------|---------------------|----------|
| Pin Hugo to official Docker image | HIGH (site doesn't publish without this) | LOW | P1 |
| Delete `hooks/` (hardcoded password) | HIGH (security) | LOW | P1 |
| Remove stray files | MEDIUM (repo hygiene) | LOW | P1 |
| Update `.gitignore` | MEDIUM (prevents recurrence) | LOW | P1 |
| Tighten `.dockerignore` | LOW (minor build optimization) | LOW | P2 |
| Pin NGINX base image version | MEDIUM (reproducibility) | LOW | P2 |
| Add `--minify` to Hugo build | LOW (performance) | LOW | P2 |
| Multi-platform builds | LOW (not needed for current cluster) | MEDIUM | P3 |
| Docker layer caching | LOW (infrequent builds) | MEDIUM | P3 |
| Vulnerability scanning | LOW (personal blog) | MEDIUM | P3 |

**Priority key:**
- P1: Must have for CI to pass and pipeline to be secure
- P2: Should have, add in same pass or shortly after
- P3: Nice to have, future consideration

---

## Ecosystem Context

### Hugo Docker Image Options (as of 2026-02)

The Debian apt package lags significantly. Debian trixie (current stable) ships Hugo 0.131.0; the current Hugo release is 0.157.0. Many newer themes and config features require 0.140+. **Using apt is the root cause of the broken build.**

Official options (HIGH confidence — verified against gohugoio/hugo GitHub and hugomods/docker):

| Image | What It Is | Use When |
|-------|-----------|----------|
| `ghcr.io/gohugoio/hugo:v0.157.0` | Official Hugo image from gohugoio | Greenfield or when you want the canonical source |
| `hugomods/hugo:latest-ext` | Third-party but actively maintained; extended edition | Extended features needed (Sass, WebP); cleaner Alpine base |
| `hugomods/hugo:0.157.0-ext` | Same, pinned version | Reproducibility — prefer this over `:latest-ext` |

**Extended vs standard:** Extended Hugo adds Sass/SCSS transpilation and Hugo Deploy. For this blog (no Sass, no Hugo Deploy), standard suffices — but extended works fine and avoids future surprises if theme adds Sass. Use extended.

### Woodpecker Secrets Pattern (HIGH confidence — verified against Woodpecker docs)

Secrets are stored at the repository level in Woodpecker UI and referenced with `from_secret`. The existing `.woodpecker.yml` already does this correctly for `dockerhub-pat`. **No changes needed to secrets handling.**

### Kubernetes Deployment Restart Pattern (MEDIUM confidence — verified against existing `.woodpecker.yml`)

The `curl -X PATCH` pattern to force a pod restart by updating the `restartedAt` annotation is standard kubectl-replace-equivalent behavior. The existing implementation is correct assuming the service account token is mounted at `/var/run/secrets/kubernetes.io/serviceaccount/token`.

---

## Sources

- Hugo 0.157.0 release: https://github.com/gohugoio/hugo/releases/latest (verified 2026-02-28)
- Hugo Docker images: https://github.com/hugomods/docker (verified 2026-02-28)
- Debian package versions: https://packages.debian.org/search?keywords=hugo (verified 2026-02-28: trixie=0.131.0, sid=0.157.0)
- Woodpecker CI secrets syntax: https://woodpecker-ci.org/docs/usage/secrets (verified 2026-02-28)
- Woodpecker CI workflow syntax: https://woodpecker-ci.org/docs/next/usage/workflow-syntax (verified 2026-02-28)
- Hugo extended edition features: https://gohugo.io/installation/linux/ (verified 2026-02-28)
- .gitignore patterns: https://www.toptal.com/developers/gitignore/api/hugo,python,macos (verified 2026-02-28)
- Docker buildx plugin settings: https://codeberg.org/woodpecker-plugins/plugin-docker-buildx (verified 2026-02-28)
- Project context: /Users/viktorbarzin/code/Website/.planning/PROJECT.md
- Existing pipeline: /Users/viktorbarzin/code/Website/.woodpecker.yml
- Existing Dockerfile: /Users/viktorbarzin/code/Website/Dockerfile
- Leaked credential: /Users/viktorbarzin/code/Website/hooks/build (plaintext password confirmed)

---
*Feature research for: Hugo blog CI/CD repair — personal blog (viktorbarzin.me)*
*Researched: 2026-02-28*
