<!DOCTYPE html>
<html>

    <head>
        <title> 08 Defeating Censorship And Improving Security With OpenVPN &middot; Viktor Barzin (Viktor Barzin&#39;s Website) </title>

		<meta property='og:title' content="08 Defeating Censorship And Improving Security With OpenVPN"/>
<meta property="og:image" content="https://viktorbarzin.me/images/08-defeating-censorship-with-tcp-openvpn-072ee9b6-ln.png" />
<meta property="og:description" content="In this blogpost I show you how I set up multiple OpenVPN instances - one running on port 443/tcp to mask it as regular HTTPS traffic and avoid being blocked. I show how to do it and also some neat tricks about systemd and debugging openvpn-related networking issues." />
<meta property='og:url' content="https://viktorbarzin.me/blog/08-defeating-censorship-with-tcp-openvpn/" />
<meta property='og:type' content="website" />
<meta property="og:site_name" content="Viktor Barzin (Viktor Barzin&#39;s Website And Personal Blog)" />
<meta name="description" content="In this blogpost I show you how I set up multiple OpenVPN instances - one running on port 443/tcp to mask it as regular HTTPS traffic and avoid being blocked. I show how to do it and also some neat tricks about systemd and debugging openvpn-related networking issues." />

<meta name="twitter:title" content="08 Defeating Censorship And Improving Security With OpenVPN" />
<meta name="twitter:description" content="In this blogpost I show you how I set up multiple OpenVPN instances - one running on port 443/tcp to mask it as regular HTTPS traffic and avoid being blocked. I show how to do it and also some neat tricks about systemd and debugging openvpn-related networking issues." />
<meta name="twitter:image" content="https://viktorbarzin.me/images/08-defeating-censorship-with-tcp-openvpn-072ee9b6-ln.png" />
<meta name="twitter:site" content="@viktorbarzin" />
<meta name="twitter:creator" content="@viktorbarzin" />

<script type="application/ld+json">
{
    "@context" : "http://schema.org",
    "@type" : "BlogPosting",
    "mainEntityOfPage": {
         "@type": "WebPage",
         "@id": "https:\/\/viktorbarzin.me\/"
    },
    "articleSection" : "blog",
    "name" : "08 Defeating Censorship And Improving Security With OpenVPN",
    "headline" : "08 Defeating Censorship And Improving Security With OpenVPN",
    "description" : "In this blogpost I show you how I set up multiple OpenVPN instances - one running on port 443/tcp to mask it as regular HTTPS traffic and avoid being blocked. I show how to do it and also some neat tricks about systemd and debugging openvpn-related networking issues.",
    "inLanguage" : "en-US",
    "author" : {
        "@type": "Person",
        "name": "Viktor Barzin",
        "image": "",
        "url": "https://viktorbarzin.me/",
        "description": "I've been digging into Programming for quite some time now. My passion for technology has grown into cyber security and automation. I love ot go offline, watch Formula 1, play cheess and go skiing."
    },
    "creator" : "Viktor Barzin",
    "publisher": {
        "@context": "http://schema.org",
        "@type": "Organization",
        "name": "Viktor Barzin",
        "sameAs": [
            "https://www.facebook.com/viktor.barzin",
            "https://github.com/ViktorBarzin",
            "https://twitter.com/ViktorBarzin",
            "https://www.linkedin.com/in/viktor-barzin/"
        ],
        "url": "https://viktorbarzin.me",
        "logo": {
          "@type": "ImageObject",
          "url": "https://viktorbarzin.me/images/profile-picture.jpeg"
        }
    },
    "accountablePerson" : "Viktor Barzin",
    "copyrightHolder" : "Viktor Barzin",
    "copyrightYear" : "12018",
    "datePublished": "2019-01-12T10:10:13Z",
    "dateModified" : "2019-01-12T10:10:13Z",
    "url" : "https:\/\/viktorbarzin.me\/blog\/08-defeating-censorship-with-tcp-openvpn\/",
    "wordCount" : "3298",
    "image": 	"https:\/\/viktorbarzin.me\/images\/08-defeating-censorship-with-tcp-openvpn-072ee9b6-ln.png",
    "keywords" : [ "OpenVPN","tcp OpenVPN","port 443\/tcp","iptables","SSL\/TLS","TLS","multiple openvpn","systemd","service files","systemd services","openvpn-server@.service","OpenWRT tunneling openvpn traffic","firewall","routing","learn-address","static routes","sudoers","\/sbin\/ip","linux capabilities","CapabilityBoundingSet","Blog" ]
}
</script>

<script src="//instant.page/1.2.2" type="module" integrity="sha384-2xV8M5griQmzyiY3CDqh1dn4z3llDVqZDqzjzcY+jCBCk/a5fXJmuZ/40JJAPeoU"></script>

        <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">





<script src="/jquery-3.1.1.min.js"   integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="></script>


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">


<link rel="stylesheet" href="https://viktorbarzin.me/css/nix.css">


<link href="https://fonts.googleapis.com/css?family=Inconsolata%7COpen+Sans%7CConcert+One" rel="stylesheet">





<script async src="https://www.googletagmanager.com/gtag/js?id=UA-132992428-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-132992428-1');
</script>





    </head>

    <body>
        <header>
<nav class="navbar navbar-default navbar-fixed-top navbar-inverse font-header">
	<div class="container-fluid">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse-1" aria-expanded="false">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" id="green-terminal" href=https://viktorbarzin.me/>viktor@web ~ $</a>
		</div>

		
		<div class="collapse navbar-collapse" id="navbar-collapse-1">
			<ul class="nav navbar-nav navbar-right">
				<li>
					<a href="https://viktorbarzin.me/">/home/viktor</a>
				</li>
				
				
				<li class="dropdown">
                    
            		<a href="/blog/">~/blog</a>
            		
        		</li>
        		
				
				<li class="dropdown">
                    
            		<a href="/projects/">~/projects</a>
            		
        		</li>
        		
				
				<li class="dropdown">
                    
            		<a href="/about-me/">~/about-me</a>
            		
        		</li>
        		
				
				<li class="dropdown">
                    
            		<a href="/donate/">~/donate</a>
            		
        		</li>
        		
			</ul>
		</div>
	</div>
</nav>






</header>

        <div class="container wrapper">
            <h1><a href="https://viktorbarzin.me/blog/08-defeating-censorship-with-tcp-openvpn/">08 Defeating Censorship And Improving Security With OpenVPN</a></h1>
            <span class="post-date">Jan 12, 2019 </span>
            <div class="post-content">
                

<h1 id="introduction">Introduction</h1>

<p>I do happen to travel from time to time and in order to stay online I have to use insecure public wifi.
Everyone who understands a bit about network security knows the risks of connecting to unsafe networks and how dangerous they could be.</p>

<p>One of the most common solutions to this problem, including mine, is a <a href="https://en.wikipedia.org/wiki/Virtual_private_network">VPN</a> service.
That&rsquo;s all great, however, more and more network administrators put effort into blocking VPN traffic.</p>

<p>That annoys the heck out of me so in this post I&rsquo;ll show you how I&rsquo;ve essentially bypassed any VPN filtering with some simple tweaks.</p>

<h3 id="prerequisites">Prerequisites</h3>

<p>Now before reading this blogpost, I recommend getting yourself familiar with basic <a href="https://openvpn.net/community-resources/how-to/">OpenVPN</a> as well as <a href="https://www.digitalocean.com/community/tutorials/systemd-essentials-working-with-services-units-and-the-journal">systemd</a> concepts.</p>

<p>My setup consists of a OpenVPN instance so whenever I say &ldquo;vpn&rdquo; I refer to OpenVPN entity.</p>

<p>Let&rsquo;s get started!</p>

<h1 id="how-is-openvpn-traffic-filtered">How is OpenVPN traffic filtered?</h1>

<p>Having a quick look at the network traffic, we can easily spot the OpenVPN traffic:</p>

<p><img src="/images/08-defeating-censorship-with-tcp-openvpn-bbd7bf06.png" alt="" /></p>

<p>The image shows the beginning of the communication - firstly the <em>DNS</em> query, followed by the OpenVPN TLS handshake and finishing with the first packets of encrypted data sent over the secure channel.</p>

<p>By default, OpenVPN runs on port <em>1194/UDP</em> so filtering it can be as simple as</p>

<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#999;font-style:italic"># iptables -A FORWARD -p udp --destination-port 1194 -j DROP</span></code></pre></div>

<p>Nowadays, network admins would probably use a more GUI-like user interface to do that, but that&rsquo;s essentially what it boils down to.</p>

<p>Port 1194 is what Wireshark recognises as OpenVPN traffic as well:</p>

<p><img src="/images/08-defeating-censorship-with-tcp-openvpn-9e9c4f43.png" alt="" /></p>

<h1 id="what-can-we-do-about-it">What can we do about it?</h1>

<p>Whenever you connect to a secure website (including my blog) you are essentially sending HTTP requests over an encrypted channel that is set up beforehand.
The <a href="https://www.instantssl.com/ssl.html">SSL</a>/<a href="https://en.wikipedia.org/wiki/Transport_Layer_Security">TLS</a> protocols (see <a href="https://www.globalsign.com/en/blog/ssl-vs-tls-difference/">difference between SSL and TLS</a>) lie at the heart of web security these days and there are plenty of other protocols that rely on SSL/TLS to securely transfer data around.
Once this channel is initialized, the outside world cannot see any data that travels inside it.</p>

<p>OpenVPN also uses TLS for its encrypted channel.
The TLS handshake is standardized and does not depend in any way on the protocol it carries.</p>

<p>So could we run the OpenVPN service on port 443/tcp to mask is as regular HTTPS traffic?
Absolutely!
Blocking 443/TCP would mean breaking the internet for the common user so no one will ever do it.</p>

<h1 id="the-issue-of-running-multiple-openvpn-instances">The issue of running multiple OpenVPN instances</h1>

<p>A funny thing is that in all the forums I read, everyone&rsquo; opinion was that you can run multiple instances of OpenVPN simultaneously, but no one gave any guidelines on how exactly to do that. From the scarce information that I found, 2 things became clear to me:</p>

<ul>
<li>OpenVPN does not support listening on multiple ports simultaneously by design.</li>
<li>but this task can be done and most people talk about creating 2 tap interfaces and bridging them in some fancy way</li>
</ul>

<p>I really didn&rsquo;t want to go the bridging way so I kept on looking for an alternative. What&rsquo;s more I didn&rsquo;t want to spin up an entirely separate instance - it was a <strong>must</strong> to reuse my config files and client certificates.</p>

<h1 id="systemd-hidden-gems">systemd hidden gems</h1>

<p>I looked for a more Linux-y way of solving this issue so I had a think - OpenVPN is just a daemon ran by systemd. By default it has the following config:</p>

<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#999;font-style:italic"># /lib/systemd/system/openvpn.service</span>

<span style="color:#999;font-style:italic"># This service is actually a systemd target,</span>
<span style="color:#999;font-style:italic"># but we are using a service since targets cannot be reloaded.</span>

[Unit]
<span style="color:#40ffff">Description</span>=OpenVPN service
<span style="color:#40ffff">After</span>=network.target

[Service]
<span style="color:#40ffff">Type</span>=oneshot
<span style="color:#40ffff">RemainAfterExit</span>=yes
<span style="color:#40ffff">ExecStart</span>=/bin/true
<span style="color:#40ffff">ExecReload</span>=/bin/true
<span style="color:#40ffff">WorkingDirectory</span>=/etc/openvpn

[Install]
<span style="color:#40ffff">WantedBy</span>=multi-user.target</code></pre></div>

<p>I had a second look at the directory where the service file lives (<code>/lib/systemd/system/</code>) and I noticed there are several openvpn related service files:</p>

<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@vpn:/lib/systemd/system# ls openvpn
openvpn-client@.service  openvpn-server@.service  openvpn.service          openvpn@.service
root@vpn:/lib/systemd/system# ls openvpn</code></pre></div>

<p>When managing the OpenVPN service I&rsquo;ve always used the <em>openvpn</em> unit file, but what&rsquo;s that fancy <code>openvpn-server@.service</code> thingy?</p>

<p>That &ldquo;<strong>@</strong>&rdquo; looks dodgy, let&rsquo;s see what it stands for in the unit file name.</p>

<p>The answer lies in section 5 of the systemd manpage (<code>man 5 systemd.service</code>)</p>

<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">Table <span style="color:#3677a9">1</span>. Special executable prefixes
┌───────┬───────────────────────────────────────────┐
│Prefix │ Effect                                    │
├───────┼───────────────────────────────────────────┤
│<span style="color:#ed9d13">&#34;@&#34;</span>    │ If the executable path is prefixed with   │
│       │ <span style="color:#ed9d13">&#34;@&#34;</span>, the second specified token will be   │
│       │ passed as <span style="color:#ed9d13">&#34;argv[0]&#34;</span> to the executed       │
│       │ process (instead of the actual filename), │
│       │ followed by the further arguments         │
│       │ specified.                                │
├───────┼───────────────────────────────────────────┤</code></pre></div>

<p>Woah! <em>systemd</em> can pass arguments to the daemon executables it runs, how awesome is that!</p>

<p>Having a look at the <code>openvpn-server@.service</code> file we can see that it&rsquo;s more complicated that the first one:</p>

<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 1</span><span style="color:#999;font-style:italic"># /lib/systemd/system/openvpn-server@.service</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 3</span>[Unit]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 4</span><span style="color:#40ffff">Description</span>=OpenVPN service <span style="color:#6ab825;font-weight:bold">for</span> %I
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 5</span><span style="color:#40ffff">After</span>=syslog.target network-online.target
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 6</span><span style="color:#40ffff">Wants</span>=network-online.target
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 7</span><span style="color:#40ffff">Documentation</span>=man:openvpn(<span style="color:#3677a9">8</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 8</span><span style="color:#40ffff">Documentation</span>=https://community.openvpn.net/openvpn/wiki/Openvpn24ManPage
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 9</span><span style="color:#40ffff">Documentation</span>=https://community.openvpn.net/openvpn/wiki/HOWTO
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">10</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">11</span>[Service]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">12</span><span style="color:#40ffff">Type</span>=notify
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">13</span><span style="color:#40ffff">PrivateTmp</span>=<span style="color:#24909d">true</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">14</span><span style="color:#40ffff">WorkingDirectory</span>=/etc/openvpn/server
<span style="display:block;width:100%;background-color:#363636"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">15</span><span style="color:#40ffff">ExecStart</span>=/usr/sbin/openvpn --status %t/openvpn-server/status-%i.log --status-version <span style="color:#3677a9">2</span> --suppress-timestamps --config %i.conf
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">16</span><span style="color:#40ffff">CapabilityBoundingSet</span>=CAP_IPC_LOCK CAP_NET_ADMIN CAP_NET_BIND_SERVICE CAP_NET_RAW CAP_SETGID CAP_SETUID CAP_SYS_CHROOT CAP_DAC_OVERRIDE
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">17</span><span style="color:#40ffff">LimitNPROC</span>=<span style="color:#3677a9">10</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">18</span><span style="color:#40ffff">DeviceAllow</span>=/dev/null rw
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">19</span><span style="color:#40ffff">DeviceAllow</span>=/dev/net/tun rw
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">20</span><span style="color:#40ffff">ProtectSystem</span>=<span style="color:#24909d">true</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">21</span><span style="color:#40ffff">ProtectHome</span>=<span style="color:#24909d">true</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">22</span><span style="color:#40ffff">KillMode</span>=process
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">23</span><span style="color:#40ffff">RestartSec</span>=5s
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">24</span><span style="color:#40ffff">Restart</span>=on-failure
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">25</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">26</span>[Install]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">27</span><span style="color:#40ffff">WantedBy</span>=multi-user.target</code></pre></div>

<p>I&rsquo;m interested in the <code>ExecStart</code> directive as this is what is being executed as a &lsquo;service&rsquo;.
Obviously, this is the OpenVPN daemon being started and I&rsquo;m keen on learning what this &lsquo;<strong>%i</strong>&rsquo; stands for since the config I want it to use is referenced as &lsquo;<strong>%i.conf</strong>&rsquo; (at the end of line 15)</p>

<p>Having a look at <code>man 5 systemd.unit</code> shows a neat table that explains is well:</p>

<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">Table <span style="color:#3677a9">4</span>. Specifiers available in unit files
┌──────────┬────────────────────────────┬─────────────────────────────┐
│Specifier │ Meaning                    │ Details                     │
├──────────┼────────────────────────────┼─────────────────────────────┤
│<span style="color:#ed9d13">&#34;%i&#34;</span>      │ Instance name              │ For instantiated units this │
│          │                            │ is the string between the   │
│          │                            │ first <span style="color:#ed9d13">&#34;@&#34;</span> character and the │
│          │                            │ <span style="color:#24909d">type</span> suffix. Empty <span style="color:#6ab825;font-weight:bold">for</span>      │
│          │                            │ non-instantiated units.     │
├──────────┼────────────────────────────┼─────────────────────────────┤</code></pre></div>

<p>Aha! So I could start a openvpn-server@<strong>some_name</strong>.service and that would start an OpenVPN instance using <strong>some_name</strong>.conf as a config file.</p>

<p>By default, there is no <em>server</em> directory in <em>/etc/openvpn</em> so after we make that we should get our hands on creating the new tcp config file:</p>

<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#999;font-style:italic"># mkdir /etc/openvpn/server &amp;&amp; cp /etc/openvpn/openvpn.conf /etc/openvpn/server/tcp.conf</span></code></pre></div>

<p>We want to have the same config, to make use of the same client certificates and what not, but run on port 443/tcp.
So the config has to be mostly the same with only a few changes :</p>

<p><img src="/images/08-defeating-censorship-with-tcp-openvpn-641a88d0.png" alt="" /></p>

<p>Let me explain why each of the changes is needed:</p>

<ul>
<li>server directive - instances need to have different IPs otherwise routing would get messed up and the kernel would not know which interface to use when sending data to clients</li>
<li>proto directive - we want a <em>tcp</em> instance so that&rsquo;s quite obvious</li>
<li>port - same reason</li>
<li>dev - we need to setup a different interface that would handle clients connecting to the tcp instance. If we let both instances use the same interface we might get quite odd networking issues</li>
<li>status - can be the same though it&rsquo;s handy to have separate log files for each instance</li>
</ul>

<p>The rest of the config is the same. So let&rsquo;s start the second instance and keep our fingers crossed:</p>

<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#999;font-style:italic"># systemctl start openvpn-server@tcp</span></code></pre></div>

<p>That seemed to have done the trick since the vpn instance was up and running.</p>

<p>Then I quickly crafted a client certificate that would be an exact copy of an existing one, with the exception of the port and the ip address.</p>

<p>Now if you&rsquo;ve read my <a href="/blog/03-a-walk-down-infrastructure-lane/#the-public-part">post</a> about my home network topology, you know that the only port I have on my disposal on the site where I&rsquo;m hosting my vpn server is 1194.</p>

<p>However, I&rsquo;d like to run another instance of OpenVPN that listens on another port. So I&rsquo;ve hit a wall there &hellip;</p>

<p>&hellip; or have I?</p>

<h1 id="openwrt-to-the-rescue">OpenWRT to the rescue</h1>

<p>Running OpenVPN over tcp hurts performance significantly due to the way of how tcp works.
I&rsquo;m setting up this instance not to be fast, but to be stealthy so I am ready to sacrifice a little bit of performance.
Now given that I desperately need hole through which I can smuggle my service and that performance is not a priority, perhaps I could
make it run via my home router as I&rsquo;ve <a href="/blog/03-a-walk-down-infrastructure-lane/#the-public-part">done previously</a> with this site.</p>

<p>This would mean running a OpenVPN instance inside another OpenVPN instance.</p>

<p><img src="/images/08-defeating-censorship-with-tcp-openvpn-8e6179ed.png" alt="" /></p>

<h1 id="the-meat-of-this-hack">The meat of this hack</h1>

<p>Let&rsquo;s step back and see what that means. Hopefully this picture clarifies things a bit:</p>

<p><img src="/images/08-defeating-censorship-with-tcp-openvpn-072ee9b6.png" alt="" /></p>

<p>Firstly, UDP clients are not affected in any way.
My home router is one and I use its udp vpn connection to send tcp vpn traffic from the client on the left.
When that nested conenction reaches the server, the udp one is stripped away and then the tcp connection afterwards so in the traffic logs on the server you could tell both clients appart even though one carries the traffic of the other.</p>

<p>Let&rsquo;s see if this even works:</p>

<p><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">╭─viktor@yuhu <span style="color:#3677a9">11</span>:31:25 ~/
╰─$ sudo openvpn viktor-tcp.ovpn
Tue Jan <span style="color:#3677a9">08</span> <span style="color:#3677a9">19</span>:09:02 <span style="color:#3677a9">2019</span> OpenVPN <span style="color:#3677a9">2</span>.4.6 x86_64-redhat-linux-gnu [SSL (OpenSSL)] [LZO] [LZ4] [EPOLL] [PKCS11] [MH/PKTINFO]
[AEAD] built on Oct  <span style="color:#3677a9">6</span> <span style="color:#3677a9">2018</span>
Tue Jan <span style="color:#3677a9">08</span> <span style="color:#3677a9">19</span>:09:02 <span style="color:#3677a9">2019</span> library versions: OpenSSL <span style="color:#3677a9">1</span>.1.1 FIPS  <span style="color:#3677a9">11</span> Sep <span style="color:#3677a9">2018</span>, LZO <span style="color:#3677a9">2</span>.08
Tue Jan <span style="color:#3677a9">08</span> <span style="color:#3677a9">19</span>:09:02 <span style="color:#3677a9">2019</span> TCP/UDP: Preserving recently used remote address: [AF_INET]<span style="color:#3677a9">213</span>.191.184.70:443
Tue Jan <span style="color:#3677a9">08</span> <span style="color:#3677a9">19</span>:09:02 <span style="color:#3677a9">2019</span> Attempting to establish TCP connection with [AF_INET]<span style="color:#3677a9">213</span>.191.184.70:443 [nonblock]
Tue Jan <span style="color:#3677a9">08</span> <span style="color:#3677a9">19</span>:09:03 <span style="color:#3677a9">2019</span> TCP connection established with [AF_INET]<span style="color:#3677a9">213</span>.191.184.70:443
Tue Jan <span style="color:#3677a9">08</span> <span style="color:#3677a9">19</span>:09:03 <span style="color:#3677a9">2019</span> TCP_CLIENT link local: (not bound)
Tue Jan <span style="color:#3677a9">08</span> <span style="color:#3677a9">19</span>:09:03 <span style="color:#3677a9">2019</span> TCP_CLIENT link remote: [AF_INET]<span style="color:#3677a9">213</span>.191.184.70:443
Tue Jan <span style="color:#3677a9">08</span> <span style="color:#3677a9">19</span>:09:04 <span style="color:#3677a9">2019</span> [vpn.samitor.com] Peer Connection Initiated with [AF_INET]<span style="color:#3677a9">213</span>.191.184.70:443
Tue Jan <span style="color:#3677a9">08</span> <span style="color:#3677a9">19</span>:09:05 <span style="color:#3677a9">2019</span> Options error: Unrecognized option or missing or extra parameter(s) in [PUSH-OPTIONS]:1:
block-outside-dns (<span style="color:#3677a9">2</span>.4.6)
Tue Jan <span style="color:#3677a9">08</span> <span style="color:#3677a9">19</span>:09:05 <span style="color:#3677a9">2019</span> TUN/TAP device tun0 opened
Tue Jan <span style="color:#3677a9">08</span> <span style="color:#3677a9">19</span>:09:05 <span style="color:#3677a9">2019</span> do_ifconfig, tt-&gt;did_ifconfig_ipv6_setup=<span style="color:#3677a9">0</span>
Tue Jan <span style="color:#3677a9">08</span> <span style="color:#3677a9">19</span>:09:05 <span style="color:#3677a9">2019</span> /sbin/ip link <span style="color:#24909d">set</span> dev tun0 up mtu <span style="color:#3677a9">1500</span>
Tue Jan <span style="color:#3677a9">08</span> <span style="color:#3677a9">19</span>:09:05 <span style="color:#3677a9">2019</span> /sbin/ip addr add dev tun0 <span style="color:#24909d">local</span> <span style="color:#3677a9">10</span>.3.2.1 peer <span style="color:#3677a9">10</span>.3.2.2
Tue Jan <span style="color:#3677a9">08</span> <span style="color:#3677a9">19</span>:09:05 <span style="color:#3677a9">2019</span> WARNING: this configuration may cache passwords in memory -- use the auth-nocache option to
prevent this
<span style="display:block;width:100%;background-color:#363636">Tue Jan <span style="color:#3677a9">08</span> <span style="color:#3677a9">19</span>:09:05 <span style="color:#3677a9">2019</span> Initialization Sequence Completed</span></code></pre></div>
So we should be done by now right?</p>

<p>Ehm, not quite:</p>

<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">╭─viktor@yuhu <span style="color:#3677a9">19</span>:09:20 ~/
╰─$ ping <span style="color:#3677a9">192</span>.168.254.1
PING <span style="color:#3677a9">192</span>.168.254.1 (<span style="color:#3677a9">192</span>.168.254.1) <span style="color:#3677a9">56</span>(<span style="color:#3677a9">84</span>) bytes of data.
^C
--- <span style="color:#3677a9">192</span>.168.254.1 ping statistics ---
<span style="color:#3677a9">6</span> packets transmitted, <span style="color:#3677a9">0</span> received, <span style="color:#3677a9">100</span>% packet loss, <span style="color:#24909d">time</span> 158ms</code></pre></div>

<p>There is neither ping on any of the machines on the internal network, nor access to public addresses.</p>

<h1 id="is-it-the-firewall-or-the-routing">Is it the firewall or the routing?</h1>

<p>So the OpenVPNpn client log indicates that a connection with the vpn server on the other side has been made successfully, but there is no internet access.
Now there are a few probable reasons for that:</p>

<ul>
<li>A: firewall dropping packets somewhere along the route</li>
<li>B: misconfigured routes somewhere, most-likely on the vpn vm but can be elsewhere (maybe home router?)</li>
<li>C: both?</li>
</ul>

<h1 id="putting-the-debugging-hat-on">Putting the debugging hat on</h1>

<p>The good news is that I don&rsquo;t have to debug the OpenVPN thingy but instead a networking issue.
Firing up <code>tcpdump</code> everywhere yeilded an odd result - the ping is being received by the vpn vm, however, nothing is sent back.</p>

<p>So it&rsquo;s probably <code>iptables</code> that&rsquo;s stopping my traffic isn&rsquo;t it?
Let&rsquo;s stop it for a moment:
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#999;font-style:italic"># iptables -P {INPUT,OUTPUT,FORWARD} ACCEPT</span></code></pre></div></p>

<p>Nope, still no ping back.</p>

<p>Then, surely, it must be an issue with the routing table.
The weird thing about the whole thing was that I could cleary see the echo requests on tcpdump, but could not see any echo replies - if it was a routing error I would see the echo replies going out from a wrong interface, but I couldn&rsquo;t see any!</p>

<p>This took a good couple of days to figure out.</p>

<h1 id="openvpn-routing-quirks">OpenVPN routing quirks</h1>

<p>I found this nice <a href="https://thomas.gouverneur.name/2014/02/openvpn-listen-on-tcp-and-udp-with-tun/">blog post</a> from 2014 that explained how to do the entire thing - run a tcp and an udp instances of OpenVPN with the same config and without using a <em>tap</em> interface.</p>

<p>I had done most of the stuff the guy explained, I&rsquo;ve just missed the last part - the routing.
There is this simple script that I&rsquo;d missed. It takes care of the routing whenever a client connects and disconnects.
Basically, each time a client (dis)connects a static /32 route is being added   /removed that would tell the kernel to route the client via the according interface - if the client connected via tcp aka tun1 - then route him via that interface.
Otherwise route the client via the default tun0 interface:</p>

<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#cd2828;font-weight:bold">#!/bin/bash
</span><span style="color:#cd2828;font-weight:bold"></span><span style="color:#999;font-style:italic"># /etc/openvpn/scripts/learn-address.sh</span>
<span style="color:#999;font-style:italic">##</span>
<span style="color:#999;font-style:italic"># learn-address script which allow</span>
<span style="color:#999;font-style:italic"># OpenVPN to run on both TCP and UDP</span>
<span style="color:#999;font-style:italic"># with the same range of address on both</span>
<span style="color:#999;font-style:italic"># protocol.</span>
#
<span style="color:#999;font-style:italic"># tgouverneur -- 2014</span>
<span style="color:#999;font-style:italic">##</span>

<span style="color:#6ab825;font-weight:bold">if</span> [ <span style="color:#40ffff">$#</span> -lt <span style="color:#3677a9">2</span> ]; <span style="color:#6ab825;font-weight:bold">then</span>
  <span style="color:#24909d">exit</span> <span style="color:#3677a9">0</span>;
<span style="color:#6ab825;font-weight:bold">fi</span>
<span style="color:#40ffff">action</span>=<span style="color:#40ffff">$1</span>;
<span style="color:#40ffff">addr</span>=<span style="color:#40ffff">$2</span>;

<span style="color:#6ab825;font-weight:bold">case</span> <span style="color:#ed9d13">${</span><span style="color:#40ffff">action</span><span style="color:#ed9d13">}</span> in
        add|update)
                <span style="color:#24909d">echo</span> <span style="color:#ed9d13">&#34;[-] </span><span style="color:#ed9d13">${</span><span style="color:#40ffff">addr</span><span style="color:#ed9d13">}</span><span style="color:#ed9d13"> logged in to </span><span style="color:#ed9d13">${</span><span style="color:#40ffff">dev</span><span style="color:#ed9d13">}</span><span style="color:#ed9d13">&#34;</span> &gt;&gt; /etc/openvpn/server/tcp-vpn.log
                /usr/bin/sudo /sbin/ip ro del <span style="color:#ed9d13">${</span><span style="color:#40ffff">addr</span><span style="color:#ed9d13">}</span>/32
                /usr/bin/sudo /sbin/ip ro add <span style="color:#ed9d13">${</span><span style="color:#40ffff">addr</span><span style="color:#ed9d13">}</span>/32 dev <span style="color:#ed9d13">${</span><span style="color:#40ffff">dev</span><span style="color:#ed9d13">}</span>;
        ;;
        delete)
               <span style="color:#24909d">echo</span> <span style="color:#ed9d13">&#34;[-] Deleting addr </span><span style="color:#ed9d13">${</span><span style="color:#40ffff">addr</span><span style="color:#ed9d13">}</span><span style="color:#ed9d13"> -&gt; </span><span style="color:#ed9d13">${</span><span style="color:#40ffff">dev</span><span style="color:#ed9d13">}</span><span style="color:#ed9d13">&#34;</span> &gt;&gt; /etc/openvpn/server/tcp-vpn.log
               /usr/bin/sudo /sbin/ip ro del <span style="color:#ed9d13">${</span><span style="color:#40ffff">addr</span><span style="color:#ed9d13">}</span>/32
        ;;
        *)
        ;;
<span style="color:#6ab825;font-weight:bold">esac</span>

<span style="color:#24909d">exit</span> <span style="color:#3677a9">0</span>;</code></pre></div>

<p>Neat right?</p>

<p>We want this script to be executed each time a client (dis)connects.</p>

<p>There is a special directive in the OpenVPN server config for that (have to put it in both configs):</p>

<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#999;font-style:italic"># /etc/openvpn/openvpn.conf</span>
<span style="color:#999;font-style:italic"># /etc/openvpn/server/tcp.conf</span>
 --- snip ---
learn-address /etc/openvpn/scripts/learn-address.sh</code></pre></div>

<h4 id="ps-remember-to-add-your-vpn-daemon-user-to-sudoers-and-allow-him-to-execute-sbin-ip-as-root-it-needs-to-be-able-to-change-system-routes">PS: Remember to add your vpn daemon user to sudoers and allow him to execute <em>/sbin/ip</em> as root - it needs to be able to change system routes:</h4>

<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#999;font-style:italic"># /etc/sudoers</span>
 --- snip ---
vpn <span style="color:#40ffff">ALL</span>=(ALL:ALL) NOPASSWD: /sbin/ip</code></pre></div>

<p>Finally it should be good to go!</p>

<h1 id="not-yet">Not yet&hellip;</h1>

<p>Alas even with this tweak there was no connection going out of the vpn server to the clients&hellip;</p>

<p>This time I decided to have a look at the server logs - something must have gone wrong server-side!</p>

<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 1</span>root@vpn:/etc/openvpn/server# journalctl -f -u openvpn-server@tcp -b
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 2</span>-- Logs begin at Fri <span style="color:#3677a9">2018</span>-09-21 <span style="color:#3677a9">20</span>:18:43 EEST. --
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 3</span>Jan <span style="color:#3677a9">10</span> <span style="color:#3677a9">21</span>:52:51 vpn openvpn[<span style="color:#3677a9">28814</span>]: Socket Buffers: <span style="color:#40ffff">R</span>=[<span style="color:#3677a9">87380</span>-&gt;87380] <span style="color:#40ffff">S</span>=[<span style="color:#3677a9">16384</span>-&gt;16384]
<span style="display:block;width:100%;background-color:#363636"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 4</span>Jan <span style="color:#3677a9">10</span> <span style="color:#3677a9">21</span>:52:51 vpn openvpn[<span style="color:#3677a9">28814</span>]: Listening <span style="color:#6ab825;font-weight:bold">for</span> incoming TCP connection on [AF_INET][undef]:443
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 5</span>--- snip ---
<span style="display:block;width:100%;background-color:#363636"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 6</span>Jan <span style="color:#3677a9">10</span> <span style="color:#3677a9">21</span>:52:57 vpn openvpn[<span style="color:#3677a9">28814</span>]: <span style="color:#3677a9">10</span>.3.2.9:13131 [sgs7] Peer Connection Initiated with [AF_INET]<span style="color:#3677a9">10</span>.3.2.9:13131
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 7</span>Jan <span style="color:#3677a9">10</span> <span style="color:#3677a9">21</span>:52:57 vpn openvpn[<span style="color:#3677a9">28814</span>]: sgs7/10.3.2.9:13131 OPTIONS IMPORT: reading client specific options from: /etc/openvpn/ccd/sgs7
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 8</span>Jan <span style="color:#3677a9">10</span> <span style="color:#3677a9">21</span>:52:57 vpn openvpn[<span style="color:#3677a9">28814</span>]: sgs7/10.3.2.9:13131 OPTIONS IMPORT: reading client specific options from: /tmp/openvpn_cc_2550293368432e205dcedc71562a78a3.tmp
<span style="display:block;width:100%;background-color:#363636"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 9</span>Jan <span style="color:#3677a9">10</span> <span style="color:#3677a9">21</span>:52:57 vpn sudo[<span style="color:#3677a9">28844</span>]:      vpn : <span style="color:#40ffff">TTY</span>=unknown ; <span style="color:#40ffff">PWD</span>=/etc/openvpn/server ; <span style="color:#40ffff">USER</span>=root ; <span style="color:#40ffff">COMMAND</span>=/sbin/ip ro del <span style="color:#3677a9">10</span>.3.2.5/32
</span><span style="display:block;width:100%;background-color:#363636"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">10</span>Jan <span style="color:#3677a9">10</span> <span style="color:#3677a9">21</span>:52:57 vpn openvpn[<span style="color:#3677a9">28814</span>]: sudo: unable to send audit message
</span><span style="display:block;width:100%;background-color:#363636"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">11</span>Jan <span style="color:#3677a9">10</span> <span style="color:#3677a9">21</span>:52:57 vpn sudo[<span style="color:#3677a9">28844</span>]: PAM audit_log_acct_message() failed: Operation not permitted
</span><span style="display:block;width:100%;background-color:#363636"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">12</span>Jan <span style="color:#3677a9">10</span> <span style="color:#3677a9">21</span>:52:57 vpn sudo[<span style="color:#3677a9">28844</span>]: pam_unix(sudo:session): session opened <span style="color:#6ab825;font-weight:bold">for</span> user root by (<span style="color:#40ffff">uid</span>=<span style="color:#3677a9">0</span>)
</span><span style="display:block;width:100%;background-color:#363636"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">13</span>Jan <span style="color:#3677a9">10</span> <span style="color:#3677a9">21</span>:52:57 vpn sudo[<span style="color:#3677a9">28844</span>]:      vpn : pam_open_session: System error ; <span style="color:#40ffff">TTY</span>=unknown ; <span style="color:#40ffff">PWD</span>=/etc/openvpn/server ; <span style="color:#40ffff">USER</span>=root ; <span style="color:#40ffff">COMMAND</span>=/sbin/ip ro del <span style="color:#3677a9">10</span>.3.2.5/32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">14</span>Jan <span style="color:#3677a9">10</span> <span style="color:#3677a9">21</span>:52:57 vpn openvpn[<span style="color:#3677a9">28814</span>]: sudo: pam_open_session: System error
<span style="display:block;width:100%;background-color:#363636"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">15</span>Jan <span style="color:#3677a9">10</span> <span style="color:#3677a9">21</span>:52:57 vpn openvpn[<span style="color:#3677a9">28814</span>]: sudo: policy plugin failed session initialization
</span><span style="display:block;width:100%;background-color:#363636"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">16</span>Jan <span style="color:#3677a9">10</span> <span style="color:#3677a9">21</span>:52:57 vpn sudo[<span style="color:#3677a9">28845</span>]:      vpn : <span style="color:#40ffff">TTY</span>=unknown ; <span style="color:#40ffff">PWD</span>=/etc/openvpn/server ; <span style="color:#40ffff">USER</span>=root ; <span style="color:#40ffff">COMMAND</span>=/sbin/ip ro add <span style="color:#3677a9">10</span>.3.2.5/32 dev tun1
</span><span style="display:block;width:100%;background-color:#363636"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">17</span>Jan <span style="color:#3677a9">10</span> <span style="color:#3677a9">21</span>:52:57 vpn sudo[<span style="color:#3677a9">28845</span>]: PAM audit_log_acct_message() failed: Operation not permitted
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">18</span>Jan <span style="color:#3677a9">10</span> <span style="color:#3677a9">21</span>:52:57 vpn openvpn[<span style="color:#3677a9">28814</span>]: sudo: unable to send audit message
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">19</span>Jan <span style="color:#3677a9">10</span> <span style="color:#3677a9">21</span>:52:57 vpn sudo[<span style="color:#3677a9">28845</span>]: pam_unix(sudo:session): session opened <span style="color:#6ab825;font-weight:bold">for</span> user root by (<span style="color:#40ffff">uid</span>=<span style="color:#3677a9">0</span>)
<span style="display:block;width:100%;background-color:#363636"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">20</span>Jan <span style="color:#3677a9">10</span> <span style="color:#3677a9">21</span>:52:57 vpn openvpn[<span style="color:#3677a9">28814</span>]: sudo: pam_open_session: System error
</span><span style="display:block;width:100%;background-color:#363636"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">21</span>Jan <span style="color:#3677a9">10</span> <span style="color:#3677a9">21</span>:52:57 vpn openvpn[<span style="color:#3677a9">28814</span>]: sudo: policy plugin failed session initialization
</span><span style="display:block;width:100%;background-color:#363636"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">22</span>Jan <span style="color:#3677a9">10</span> <span style="color:#3677a9">21</span>:52:57 vpn sudo[<span style="color:#3677a9">28845</span>]:      vpn : pam_open_session: System error ; <span style="color:#40ffff">TTY</span>=unknown ; <span style="color:#40ffff">PWD</span>=/etc/openvpn/server ; <span style="color:#40ffff">USER</span>=root ; <span style="color:#40ffff">COMMAND</span>=/sbin/ip ro add <span style="color:#3677a9">10</span>.3.2.5/32 dev tun1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">23</span>Jan <span style="color:#3677a9">10</span> <span style="color:#3677a9">21</span>:52:57 vpn openvpn[<span style="color:#3677a9">28814</span>]: sgs7/10.3.2.9:13131 MULTI: Learn: <span style="color:#3677a9">10</span>.3.2.5 -&gt; sgs7/10.3.2.9:13131
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">24</span>Jan <span style="color:#3677a9">10</span> <span style="color:#3677a9">21</span>:52:57 vpn openvpn[<span style="color:#3677a9">28814</span>]: sgs7/10.3.2.9:13131 MULTI: primary virtual IP <span style="color:#6ab825;font-weight:bold">for</span> sgs7/10.3.2.9:13131: <span style="color:#3677a9">10</span>.3.2.5
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">25</span>--- snip ---</code></pre></div>

<p>From this log snippet I could tell that the daemon has started listening successfully (line 4), client has connected without any problems either (line 6) but then when running the <em>learn-address</em> script there is this <strong>&ldquo;Operation not permitted&rdquo;</strong> on multiple instances.</p>

<p>You could cleary see that <strong>root</strong> is executing the <code>/sbin/ip</code> command (so <em>/etc/sudoers</em> is read properly) but then why does it still get permission denied?</p>

<p>Debugging this issue was a hard one.</p>

<p>Eventually I found the answer in a <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=792653">debian bug report logs on openvpn</a>.</p>

<p>The issue was in the <em>.service</em> file of the openvpn tcp instance.
The <strong><a href="https://www.freedesktop.org/software/systemd/man/systemd.exec.html#Capabilities">CapabilityBoundingSet</a></strong> directive controls what capabilities the started process will run with.</p>

<p>Apparently the default set does not include the capability for changing routes (or some other, I haven&rsquo;t figure it out).</p>

<p>The easiest way to fix it is just to comment out that line:</p>

<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#999;font-style:italic"># /lib/systemd/system/openvpn-server@.service</span>
 --- snip ---
[Service]
<span style="color:#40ffff">Type</span>=notify
<span style="color:#40ffff">PrivateTmp</span>=<span style="color:#24909d">true</span>
<span style="color:#40ffff">WorkingDirectory</span>=/etc/openvpn/server
<span style="color:#40ffff">ExecStart</span>=/usr/sbin/openvpn --status %t/openvpn-server/status-%i.log --status-version <span style="color:#3677a9">2</span> --suppress-timestamps --config %i.conf
<span style="display:block;width:100%;background-color:#363636"><span style="color:#999;font-style:italic">#CapabilityBoundingSet=CAP_IPC_LOCK CAP_NET_ADMIN CAP_NET_BIND_SERVICE CAP_NET_RAW CAP_SETGID CAP_SETUID CAP_SYS_CHROOT CAP_DAC_OVERRIDE</span>
</span><span style="color:#40ffff">LimitNPROC</span>=<span style="color:#3677a9">10</span>
<span style="color:#40ffff">DeviceAllow</span>=/dev/null rw
<span style="color:#40ffff">DeviceAllow</span>=/dev/net/tun rw
<span style="color:#40ffff">ProtectSystem</span>=<span style="color:#24909d">true</span>
<span style="color:#40ffff">ProtectHome</span>=<span style="color:#24909d">true</span>
<span style="color:#40ffff">KillMode</span>=process
<span style="color:#40ffff">RestartSec</span>=5s
<span style="color:#40ffff">Restart</span>=on-failure
 --- snip ---</code></pre></div>

<p>Obviously the best way to fix it, is to find out what capability it is missing and add it to the list.
In my case it&rsquo;s not mission critical given that I run my default OpenVPN with default capabilities, I don&rsquo;t see that as an issue for the tcp instance.</p>

<h4 id="after-restarting-the-services-i-finally-got-it-working-properly">After restarting the services I finally got it working properly:</h4>

<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@vpn:/etc/openvpn/server# journalctl -f -u openvpn-server@tcp -b
--- snip ---
Jan <span style="color:#3677a9">10</span> <span style="color:#3677a9">21</span>:56:14 vpn openvpn[<span style="color:#3677a9">29039</span>]: <span style="color:#3677a9">10</span>.3.2.9:28118 [sgs7] Peer Connection Initiated with [AF_INET]<span style="color:#3677a9">10</span>.3.2.9:28118
Jan <span style="color:#3677a9">10</span> <span style="color:#3677a9">21</span>:56:14 vpn openvpn[<span style="color:#3677a9">29039</span>]: sgs7/10.3.2.9:28118 OPTIONS IMPORT: reading client specific options from: /etc/openvpn/ccd/sgs7
Jan <span style="color:#3677a9">10</span> <span style="color:#3677a9">21</span>:56:14 vpn openvpn[<span style="color:#3677a9">29039</span>]: sgs7/10.3.2.9:28118 OPTIONS IMPORT: reading client specific options from: /tmp/openvpn_cc_1fd11ab8ec0f2dad7ebbc6eb4de16a8a.tmp
Jan <span style="color:#3677a9">10</span> <span style="color:#3677a9">21</span>:56:14 vpn sudo[<span style="color:#3677a9">29072</span>]:      vpn : <span style="color:#40ffff">TTY</span>=unknown ; <span style="color:#40ffff">PWD</span>=/etc/openvpn/server ; <span style="color:#40ffff">USER</span>=root ; <span style="color:#40ffff">COMMAND</span>=/sbin/ip ro del <span style="color:#3677a9">10</span>.3.2.5/32
Jan <span style="color:#3677a9">10</span> <span style="color:#3677a9">21</span>:56:14 vpn sudo[<span style="color:#3677a9">29072</span>]: pam_unix(sudo:session): session opened <span style="color:#6ab825;font-weight:bold">for</span> user root by (<span style="color:#40ffff">uid</span>=<span style="color:#3677a9">0</span>)
Jan <span style="color:#3677a9">10</span> <span style="color:#3677a9">21</span>:56:14 vpn openvpn[<span style="color:#3677a9">29039</span>]: RTNETLINK answers: No such process
Jan <span style="color:#3677a9">10</span> <span style="color:#3677a9">21</span>:56:14 vpn sudo[<span style="color:#3677a9">29072</span>]: pam_unix(sudo:session): session closed <span style="color:#6ab825;font-weight:bold">for</span> user root
Jan <span style="color:#3677a9">10</span> <span style="color:#3677a9">21</span>:56:14 vpn sudo[<span style="color:#3677a9">29074</span>]:      vpn : <span style="color:#40ffff">TTY</span>=unknown ; <span style="color:#40ffff">PWD</span>=/etc/openvpn/server ; <span style="color:#40ffff">USER</span>=root ; <span style="color:#40ffff">COMMAND</span>=/sbin/ip ro add <span style="color:#3677a9">10</span>.3.2.5/32 dev tun1
Jan <span style="color:#3677a9">10</span> <span style="color:#3677a9">21</span>:56:14 vpn sudo[<span style="color:#3677a9">29074</span>]: pam_unix(sudo:session): session opened <span style="color:#6ab825;font-weight:bold">for</span> user root by (<span style="color:#40ffff">uid</span>=<span style="color:#3677a9">0</span>)
Jan <span style="color:#3677a9">10</span> <span style="color:#3677a9">21</span>:56:14 vpn sudo[<span style="color:#3677a9">29074</span>]: pam_unix(sudo:session): session closed <span style="color:#6ab825;font-weight:bold">for</span> user root
Jan <span style="color:#3677a9">10</span> <span style="color:#3677a9">21</span>:56:14 vpn openvpn[<span style="color:#3677a9">29039</span>]: sgs7/10.3.2.9:28118 MULTI: Learn: <span style="color:#3677a9">10</span>.3.2.5 -&gt; sgs7/10.3.2.9:28118
Jan <span style="color:#3677a9">10</span> <span style="color:#3677a9">21</span>:56:14 vpn openvpn[<span style="color:#3677a9">29039</span>]: sgs7/10.3.2.9:28118 MULTI: primary virtual IP <span style="color:#6ab825;font-weight:bold">for</span> sgs7/10.3.2.9:28118: <span style="color:#3677a9">10</span>.3.2.5
--- snip ---</code></pre></div>

<p>.. with the appropriate route being set for tcp:</p>

<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#3677a9">10</span>.3.2.5 dev tun0 scope link</code></pre></div>

<p>and udp</p>

<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#3677a9">10</span>.3.2.5 dev tun1 scope link</code></pre></div>

<p>respectively.</p>

<h1 id="future-work">Future work</h1>

<p>There&rsquo;s a problem that I haven&rsquo;t solved yet - proxying the tcp vpn instance on port 443 at my home router raises an issue.
The router at home runs a haproxy instance on 443/tcp (<a href="/blog/05-haproxy/">read more here</a>) to forward traffic to my webserver and serve content over HTTPS.
I can&rsquo;t really tell which TLS traffic is for the website and which for the vpn - that was the point in the first place wasn&rsquo;t it.</p>

<p>Currently as I see it, I&rsquo;ll probably need another public IP but we shall see.
Or since I have the private key for the TLS certificate I might be able to make haproxy act as a router but I need to do more research on the topic.</p>

<h1 id="conclusion">Conclusion</h1>

<p>Running a second OpenVPN instance on the same machine seemed as a pretty easy task, however, there are some caveats that might get in your way.
I learnt a lot about systemd, how it operates and what awesome stuff one could do with it.
Moreover, it was fun debugging the networking issues after a client has connected and last but not least I&rsquo;ve never had to debug capabilities issues so that&rsquo;s good experience as well.</p>

<p>Getting everything to work brought me great satisfaction and a feeling of a time productively spent.</p>

<h1 id="resources">Resources</h1>

<p><a href="https://www.bestvpn.com/guides/openvpn-tcp-vs-udp-difference-choose/">OpenVPN over TCP or UDP - pros and cons</a></p>

<p><a href="https://github.com/Angristan/OpenVPN-install/issues/28">GitHub issue hinting that multiple OpenVPN instances are possible, but not without further tinkering</a></p>

<p><a href="https://github.com/Angristan/OpenVPN-install/blob/f681c0bd3426cc0f825345d483a283da537d34d2/openvpn-install.sh#L621">OpenVPN source file that searches for config files</a></p>

<p><a href="https://community.openvpn.net/openvpn/wiki/GettingStartedwithOVPN">OpenVPN tcp config from docs</a></p>

<p><a href="https://forums.openvpn.net/viewtopic.php?t=14503">OpenVPN forums thread that says OpenVPN can be run over tcp but doesn&rsquo;t specify how</a></p>

<p><a href="https://thomas.gouverneur.name/2014/02/openvpn-listen-on-tcp-and-udp-with-tun/">Thomas Gouverneur&rsquo;s blog bost on the topic that included the &lsquo;learn-address&rsquo; script</a></p>

<p><a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=792653">Debian Bug report logs where I found the capabilities issue for systemd</a></p>

<p><a href="https://www.digitalocean.com/community/tutorials/how-to-use-systemctl-to-manage-systemd-services-and-units">Digitalocean guide on systemd and how to manage services in linux</a></p>

            </div>
            
            <div class="post-comments">
                <div id="disqus_thread"></div>

<script nonce="2726c7f26v" type="application/javascript">
    var disqus_config = function () {
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "viktorbarzin" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

                
            </div>
            
            <div class="push"></div>
        </div>
        <footer class="footer text-center">
<p>Copyright &copy; 2019 Viktor Barzin
<span class="credit">
	
	
	
	
    
</span>
</p>
</footer>


    </body>
