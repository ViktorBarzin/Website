<!DOCTYPE html>
<html>

    <head>
        <title> 15 Arpspoofing Exploitation, Detection and Prevention &middot; Viktor Barzin (Viktor Barzin&#39;s Website) </title>

		<meta property='og:title' content="15 Arpspoofing Exploitation, Detection and Prevention"/>
<meta property="og:image" content="https://viktorbarzin.me/images/15-arpspoofing.png" />
<meta property="og:description" content="An article about ARP spoofing. I talk about what it is, why is it so dangerous, how it can be detected and mitigated. Finally I add a script to add to NetworkManager in Linux to defend yourself from ARP spoofing." />
<meta property='og:url' content="https://viktorbarzin.me/blog/15-arpspoofing-exploitation-detection-prevention/" />
<meta property='og:type' content="website" />
<meta property="og:site_name" content="Viktor Barzin (Viktor Barzin&#39;s Website And Personal Blog)" />
<meta name="description" content="An article about ARP spoofing. I talk about what it is, why is it so dangerous, how it can be detected and mitigated. Finally I add a script to add to NetworkManager in Linux to defend yourself from ARP spoofing." />

<meta name="twitter:title" content="15 Arpspoofing Exploitation, Detection and Prevention" />
<meta name="twitter:description" content="An article about ARP spoofing. I talk about what it is, why is it so dangerous, how it can be detected and mitigated. Finally I add a script to add to NetworkManager in Linux to defend yourself from ARP spoofing." />
<meta name="twitter:image" content="https://viktorbarzin.me/images/15-arpspoofing.png" />
<meta name="twitter:site" content="@viktorbarzin" />
<meta name="twitter:creator" content="@viktorbarzin" />

<script type="application/ld+json">
{
    "@context" : "http://schema.org",
    "@type" : "BlogPosting",
    "mainEntityOfPage": {
         "@type": "WebPage",
         "@id": "https:\/\/viktorbarzin.me\/"
    },
    "articleSection" : "blog",
    "name" : "15 Arpspoofing Exploitation, Detection and Prevention",
    "headline" : "15 Arpspoofing Exploitation, Detection and Prevention",
    "description" : "An article about ARP spoofing. I talk about what it is, why is it so dangerous, how it can be detected and mitigated. Finally I add a script to add to NetworkManager in Linux to defend yourself from ARP spoofing.",
    "inLanguage" : "en-US",
    "author" : {
        "@type": "Person",
        "name": "Viktor Barzin",
        "image": "",
        "url": "https://viktorbarzin.me/",
        "description": "I've been digging into Programming for quite some time now. My passion for technology has grown into cyber security and automation. I love ot go offline, watch Formula 1, play cheess and go skiing."
    },
    "creator" : "Viktor Barzin",
    "publisher": {
        "@context": "http://schema.org",
        "@type": "Organization",
        "name": "Viktor Barzin",
        "sameAs": [
            "https://www.facebook.com/viktor.barzin",
            "https://github.com/ViktorBarzin",
            "https://twitter.com/ViktorBarzin",
            "https://www.linkedin.com/in/viktor-barzin/"
        ],
        "url": "https://viktorbarzin.me",
        "logo": {
          "@type": "ImageObject",
          "url": "https://viktorbarzin.me/images/profile-picture.jpeg"
        }
    },
    "accountablePerson" : "Viktor Barzin",
    "copyrightHolder" : "Viktor Barzin",
    "copyrightYear" : "11038",
    "datePublished": "2020-03-11T17:10:29Z",
    "dateModified" : "2020-03-11T17:10:29Z",
    "url" : "https:\/\/viktorbarzin.me\/blog\/15-arpspoofing-exploitation-detection-prevention\/",
    "wordCount" : "1792",
    "image": 	"https:\/\/viktorbarzin.me\/images\/15-arpspoofing.png",
    "keywords" : [ "arp","spoofing","arptables","arpspoof","arping","wireshark","man in the middle","mitm","denial of service","dos","NetworkManager","arpspoofing","Blog" ]
}
</script>

<script src="//instant.page/1.2.2" type="module" integrity="sha384-2xV8M5griQmzyiY3CDqh1dn4z3llDVqZDqzjzcY+jCBCk/a5fXJmuZ/40JJAPeoU"></script>

        <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">





<script src="/jquery-3.1.1.min.js"   integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="></script>


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">


<link rel="stylesheet" href="https://viktorbarzin.me/css/nix.css">


<link href="https://fonts.googleapis.com/css?family=Inconsolata%7COpen+Sans%7CConcert+One" rel="stylesheet">





<script async src="https://www.googletagmanager.com/gtag/js?id=UA-132992428-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-132992428-1');
</script>






        
        <script nonce="2726c7f26v" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <script nonce="2726c7f26v">
            (adsbygoogle = window.adsbygoogle || []).push({
                google_ad_client: "ca-pub-9755293925267478",
                enable_page_level_ads: true
            });
        </script>

    </head>

    <body>
        <header>
  <nav
    class="navbar navbar-default navbar-fixed-top navbar-inverse font-header"
  >
    <div class="container-fluid">
      <div class="navbar-header">
        <button
          type="button"
          class="navbar-toggle collapsed"
          data-toggle="collapse"
          data-target="#navbar-collapse-1"
          aria-expanded="false"
        >
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" id="green-terminal" href="https://viktorbarzin.me/"
          >viktor@web ~
          $</a
        >
      </div>

      
      <div class="collapse navbar-collapse" id="navbar-collapse-1">
        <ul class="nav navbar-nav navbar-right">
          <li>
            <a href="https://viktorbarzin.me/"
              >/home/viktor</a
            >
          </li>
           
          <li class="dropdown">
            
            <a href="/blog/">~/blog</a>
            
          </li>
           
          <li class="dropdown">
            
            <a href="/projects/">~/projects</a>
            
          </li>
           
          <li class="dropdown">
            
            <a href="/about-me/">~/about-me</a>
            
          </li>
          
        </ul>
      </div>
      
    </div>
    
  </nav>

  
  
  

  </header>

        <div class="container wrapper">
            <h1><a href="https://viktorbarzin.me/blog/15-arpspoofing-exploitation-detection-prevention/">15 Arpspoofing Exploitation, Detection and Prevention</a></h1>
            <span class="post-date">Mar 11, 2020 </span>
            <div class="post-content">
                <h1 id="introduction">Introduction</h1>
<p>ARP spoofing is a rather nasty network attack which is not very popular because the attacker needs to be on the same LAN as the victim.
This is impractical in most cases, however, if that happens to be the case, a malicious user can easily perform attacks such as Man-In-The-Middled(MitM) and/or Denied of Service(DoS).</p>
<p>Recently I have been working on creating a attack-defense style CTF environment and ARP spoofing in the challenge network is definitely a concern.
In this blog post I&rsquo;ll share the basics of ARP spoofiing - what it is, how to do it, how to detect it and finally how to prevent it from happening on your network.</p>
<h1 id="what-is-arp">What is ARP?</h1>
<p>The <a href="https://en.wikipedia.org/wiki/Address_Resolution_Protocol">ARP</a> protocol is a network protocol that lies in between layer 2 and 3 of the OSI model (link layer and network layer).
It provides simple means to discover the link-layer address of a node on your local network.</p>
<p>Remember, link-layer addresses (MAC addresses) are used in the last hop before your packet reaches the destination node - you can use MAC addresses to address nodes on your local network but <em>not</em> on a remote network.
If you want to reach a remote machine you will do IP (network layer) routing and when the packet reaches the destination network it will use the destination node&rsquo;s link-layer address.</p>
<p>To keep it simple, let&rsquo;s look how ARP works when we want to ping a node on our local network:</p>
<p><img src="/images/15-arpspoofing-exploitation-detection-prevention-4-17-28-29.png" alt=""></p>
<h1 id="whats-the-issue-then">What&rsquo;s the issue then?</h1>
<p>It all sounds easy and simple, however, being one of the ancient protocols, ARP does not include any security whatsoever.
All messages sent are in <strong>plain text</strong>, meaning that they can be <strong>viewed, modified, spoofed, replied</strong>&hellip; you get the picture.</p>
<p>Since all communications require the MAC address of the node on the local network, generating ARP traffic is a easy as pinging some address (provided you don&rsquo;t have their address in your ARP table cache).
To do so you can simply use <code>ping</code>, for the purposes of the demo I used <code>arping</code>:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ arping -b 192.168.0.1
</code></pre></div><p>Wireshark helps inspect the ARP frame&rsquo;s body:</p>
<p><img src="/images/15-arpspoofing-exploitation-detection-prevention-3-13-39-37.png" alt=""></p>
<p>The first packet is a broadcast that I sent to find out the physical layer address of the node.
This packet is broadcasted to <code>FF:FF:FF:FF:FF:FF</code> which is the broadcast address at layer 2.
It asks <em>everybody</em> whether anyone has the MAC address I am looking for.
<em>Hopefully</em> <strong>only</strong> the device that has that MAC address will respond with their <code>MAC address</code> to <code>Source MAC address</code> I have put in the frame.</p>
<p>This happens in the other captured packet:</p>
<p><img src="/images/15-arpspoofing-exploitation-detection-prevention-3-13-49-06.png" alt=""></p>
<p>Now I bet that you already see an issue with this.</p>
<p>If you don&rsquo;t let me make it more clear:</p>
<h2 id="how-can-this-be-exploited">How can this be exploited?</h2>
<p>What happens if a malicious node listens for <code>Who has</code> broadcast packets and responds with a malicious response?
Say their own MAC address.
Well, the client/victim has no way to verify whether or not that is a response from the genuine node or not so by default they <em>trust</em> the response.
Thus, every time the client tries to reach that IP address, it will send their packets to the <em>attackers</em> MAC address instead.</p>
<p>Now the attacker has the full power to do a lot of powerful attacks.
When they receive packets from the victim, they can choose to <strong>drop</strong> them (effectively <strong>DoS</strong>-ing the victim) or forward them, but also inspect/modify them (<strong>MiTM</strong>-ing the victim).</p>
<h3 id="segway-into-attacks-and-tools">Segway into attacks and tools</h3>
<p>You can see that the attacker has <strong>full</strong> control over the victim&rsquo;s traffic from now on.
I won&rsquo;t go into details of what they can do.</p>
<p>There are a lot of great tools for doing <strong>Man in the Middle</strong>(MiTM) attacks including the <a href="https://github.com/byt3bl33d3r/MITMf">Man in the middle framework</a>, <a href="https://github.com/smikims/arpspoof">arpspoof</a>, <a href="https://github.com/deiv/driftnet">driftnet</a>, <a href="https://github.com/ggreer/dsniff">dsniff</a> and many others.
Their success will depend on the security of the application that is snooped e.g Facebook traffic is all using TLS so you won&rsquo;t have much success <em>hacking</em> somebody&rsquo;s profile but you may be able to figure out their DNS traffic and hence the sites they are visiting (see mitigation <a href="https://viktorbarzin.me/blog/14-dns-over-https/">here</a>).</p>
<h2 id="unsolicitedgratuitous-arp-reply">Unsolicited/Gratuitous ARP reply</h2>
<p>In a traditional production network most devices don&rsquo;t change IP addresses often.
This is especially true for the default gateway.
This means that the same IP address will be at the same MAC address most of the time so a node can easily <strong>cache</strong> it instead of <code>asking</code> everyone each time.</p>
<p>However, due to the insecure nature of ARP, you can <strong>send responses to ARP requests even if there is no ARP request</strong> in the first place!
Basically you can tell the victim - <em>Hey, the default gateway is now at this MAC address</em> and the client will happily update their ARP table.</p>
<p>If we look at the packet attributes in the image above, to build a unsolicited ARP reply you would use the following parameters:</p>
<ul>
<li><code>Sender MAC address: &lt;the attacker's MAC address&gt;</code></li>
<li><code>Sender IP address: &lt;the target you want to spoof traffic to&gt;</code></li>
<li><code>Target MAC address: &lt;the victim's MAC address&gt;</code> (can be <code>FF:FF:FF:FF:FF:FF</code> to send to everybody)</li>
<li><code>Target IP address: &lt;the victim's IP address&gt;</code> (can be broadcast to send if to everybody)</li>
</ul>
<p>This is called an unsolicited or gratuitous ARP reply.
The worst part is that this is part of the protocol so <strong>everybody</strong> has (and must) implemented it otherwise they would not be compatible with the <a href="https://tools.ietf.org/html/rfc826">RFC</a> and people will be angry.</p>
<p><strong>All</strong> of the tools I mentioned earlier use this technique to make ARP spoofing faster.</p>
<p>ARP spoofing is a easy as running</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ arpspoof -i &lt;interface name&gt; -t &lt;target&gt; &lt;host&gt;
</code></pre></div><p>If you open Wireshark on the victim machine, you will see the avalanche of ARP responses which trick the operating system into using the spoofed MAC address.</p>
<p>Even worse, you omit the <code>target</code> parameter and spoof the default gateway, you will broadcast yourself as being the default gateway on your LAN which will effectively trick all nodes to send their internet traffic via you!</p>
<h1 id="how-to-fix-this-mess">How to fix this mess?</h1>
<p>Well, fixing insecurities built-in a protocol is quite hard.</p>
<p>One solution is to use static MAC addresses.
This works by hard-coding a MAC-IP at each machine.
This way you know which IP is at which MAC so you can disable ARP requests altogether!
Unfortunately this solution quickly becomes a nightmare to manage.
Effectively you will have to manage <code>N^2</code> number of MAC address entries where <code>N</code> is the number of machines in your network.
Not ideal nor practical.</p>
<h1 id="arptables">arptables</h1>
<p>A workaround I came up with is <a href="https://linux.die.net/man/8/arptables">arptables</a>.
arptables is <a href="https://linux.die.net/man/8/iptables">iptables</a> for layer 2!.
It has a similar syntax for writing rules and is quite easy to filter ARP frames.</p>
<p>Listing your existing arp rules using <code>arptables</code> is exactly the way you would using <code>iptables</code>:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo arptables -nvL

Chain INPUT (policy ACCEPT 237K packets, 6623K bytes)

Chain OUTPUT (policy ACCEPT <span style="color:#3677a9">21934</span> packets, 614K bytes)

Chain FORWARD (policy ACCEPT <span style="color:#3677a9">0</span> packets, <span style="color:#3677a9">0</span> bytes)
</code></pre></div><p>Inserting rules is also the same as in <code>iptables</code>.
For instance:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo arptables -A INPUT --source-mac <span style="color:#ed9d13">\!</span> &lt;some mac&gt; -s 192.168.0.1 -j DROP
</code></pre></div><p>In fact, the rule above is what I am using to prevent arp spoofing on my machine.</p>
<p>Let&rsquo;s break it down:</p>
<ul>
<li><code>-A INPUT</code> - appends to the <code>INPUT</code> chain (I refer to the <code>iptables</code> <a href="https://www.thegeekstuff.com/2011/01/iptables-fundamentals/">manuals</a>)</li>
<li><code>--source-mac \! &lt;some mac address&gt;</code> - this matches ARP frames using any other but the mac address given (boolean NOT this source mac)</li>
<li><code>-s 192.168.0.1</code> - this specifies the source IP address (look at the unsolicited ARP frame building process above)</li>
<li><code>-j DROP</code> - drop the frame.</li>
</ul>
<p>One of the networks I use has a default gateway <code>192.168.0.1</code> and when I replace the <code>&lt;mac address&gt;</code> part with the actual MAC address of the device I create a rule that states:</p>
<h4 id="if-you-receive-an-arp-frame-that-states-it-is-from-the-default-gateway--s-19216801-but-does-not-have-the-source-mac-address-set-to-the-one-i-trust---source-mac--drop-it">If you receive an ARP frame that states it is from the default gateway (-s 192.168.0.1) but does not have the source MAC address set to the one I trust (&ndash;source-mac &lt;&gt;), drop it</h4>
<p>Now this method will work given that you know the <strong>genuine</strong> MAC address of your default gateway.</p>
<h1 id="automate-the-defense">Automate the defense</h1>
<p>Now the previous section gives a one-liner rule that will fix the ARP spoofing problem, however, it has a <em>small</em> disadvantage - as you roam networks the default gateway will have different IP address as well as different MAC address, so you will have to update this rule <strong>every</strong> time you change a network and this is quite impractical.</p>
<p>It is a simple task to automate - you just need to receive an event <em>when</em> you join a new network.
Then you can <code>grep</code> for you default gateway&rsquo;s IP and MAC addresses.
Assuming you use Linux and NetworkManager, you can use the script I wrote to automatically insert a new <code>arptables</code> rule in your ARP firewall.</p>
<p>The file you should create (if missing) is</p>
<pre><code>/etc/NetworkManager/dispatcher.d/up
</code></pre><p>Also make sure it is executable (<code>chmod +x</code>)</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#cd2828;font-weight:bold">#!/bin/bash
</span><span style="color:#cd2828;font-weight:bold"></span>
<span style="color:#40ffff">interface</span>=<span style="color:#ed9d13">&#34;wlp59s0&#34;</span>  <span style="color:#999;font-style:italic"># change this to match your default interface (ethernet or wireless)</span>

<span style="color:#6ab825;font-weight:bold">if</span> [[ <span style="color:#ed9d13">&#34;</span><span style="color:#40ffff">$1</span><span style="color:#ed9d13">&#34;</span> == <span style="color:#ed9d13">&#34;</span><span style="color:#40ffff">$interface</span><span style="color:#ed9d13">&#34;</span> ]]; <span style="color:#6ab825;font-weight:bold">then</span>
	<span style="color:#40ffff">gw_ip</span>=<span style="color:#6ab825;font-weight:bold">$(</span>arp -a | grep _gateway | awk <span style="color:#ed9d13">&#39;{print $2}&#39;</span> | sed <span style="color:#ed9d13">&#39;s/(//&#39;</span> | sed <span style="color:#ed9d13">&#39;s/)//&#39;</span><span style="color:#6ab825;font-weight:bold">)</span>
	<span style="color:#40ffff">gw_mac</span>=<span style="color:#6ab825;font-weight:bold">$(</span>arp -a | grep _gateway | awk <span style="color:#ed9d13">&#39;{print $4}&#39;</span><span style="color:#6ab825;font-weight:bold">)</span>
	arptables -A INPUT --source-mac <span style="color:#ed9d13">\!</span> <span style="color:#40ffff">$gw_mac</span> -s <span style="color:#40ffff">$gw_ip</span> -j DROP
<span style="color:#6ab825;font-weight:bold">fi</span>
</code></pre></div><p>It uses some basic linux tools to find the IP and MAC address of the gateway and insert a rule in <code>arptables</code>.</p>
<p>Thus, every time you connect to a newtork (<code>up</code> event in <code>NetworkManager</code>) this script will be run to secure you from ARP spoofing attacks.</p>
<h3 id="gotchas">Gotcha&rsquo;s</h3>
<p>Now this script will work only against people spoofing the default gateway.
It will <strong>not</strong> help against people spoofing other devices on the <strong>same</strong> network.
If you care about other devices, you will need to extend this script.</p>
<p>Also, this script assumes that there isn&rsquo;t an <strong>active</strong> ARP spoofing attack going on in the network at the time when you join.
If there is one, you might insert the MAC address of the attacker in your arptables and effectively block the genuine gateway from readvertising its MAC address to you later on.
This script is for the 99% case.
If you are on a compromised network you will need to take manual steps anyway</p>
<h1 id="conclusion">Conclusion</h1>
<p>ARP spoofing is quite unpopular attack, due to the requirement of being on the same network as the victim, however, if that condition is satisfied, it is a very powerful attack that people should be aware of.</p>
<p>Unless they have some <a href="https://en.wikipedia.org/wiki/Intrusion_detection_system">Intrusion Detection System</a> or an <a href="https://www.forcepoint.com/cyber-edu/intrusion-prevention-system-ipss">Intrusion Prevention System</a>, which most sane people don&rsquo;t have, or you have deployed static MACs to all of the ports on your switch, which is a nightmare to maintain as discussed, the average user will have a hard time detecting and mitigating when such an attack is happening.</p>
<p>I hope you found this article useful.
See you next time :)</p>

            </div>
            
            <div class="post-comments">
                <div id="disqus_thread"></div>

<script nonce="2726c7f26v" type="application/javascript">
    var disqus_config = function () {
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "viktorbarzin" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

                
            </div>
            
            <div class="push"></div>
        </div>
        <footer class="footer text-center">
<p>Copyright &copy; 2020 Viktor Barzin
<span class="credit">
	
	
	
	
    
</span>
</p>
</footer>


    </body>
