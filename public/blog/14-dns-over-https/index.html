<!DOCTYPE html>
<html>
  <head>
    <title>14 DNS Over HTTPS &middot; Viktor Barzin (Viktor Barzin&#39;s Website)</title>

    <meta property='og:title' content="14 DNS Over HTTPS"/>
<meta property="og:image" content="https://viktorbarzin.me/images/14-dns-over-https-linkedin.png" />
<meta property="og:description" content="This post is mainly about me sharing some very useful resources and bringing light onto the cool idea behind DNS-over-HTTPS (aka. DoH). I&#39;ll also share a simple setup on how to run your own DoH server to hide your DNS lookups from spying eyes." />
<meta property='og:url' content="https://viktorbarzin.me/blog/14-dns-over-https/" />
<meta property='og:type' content="website" />
<meta property="og:site_name" content="Viktor Barzin (Viktor Barzin&#39;s Website And Personal Blog)" />
<meta name="description" content="This post is mainly about me sharing some very useful resources and bringing light onto the cool idea behind DNS-over-HTTPS (aka. DoH). I&#39;ll also share a simple setup on how to run your own DoH server to hide your DNS lookups from spying eyes." />

<meta name="twitter:title" content="14 DNS Over HTTPS" />
<meta name="twitter:description" content="This post is mainly about me sharing some very useful resources and bringing light onto the cool idea behind DNS-over-HTTPS (aka. DoH). I&#39;ll also share a simple setup on how to run your own DoH server to hide your DNS lookups from spying eyes." />
<meta name="twitter:image" content="https://viktorbarzin.me/images/14-dns-over-https-linkedin.png" />
<meta name="twitter:site" content="@viktorbarzin" />
<meta name="twitter:creator" content="@viktorbarzin" />

<script type="application/ld+json">
{
    "@context" : "http://schema.org",
    "@type" : "BlogPosting",
    "mainEntityOfPage": {
         "@type": "WebPage",
         "@id": "https:\/\/viktorbarzin.me\/"
    },
    "articleSection" : "blog",
    "name" : "14 DNS Over HTTPS",
    "headline" : "14 DNS Over HTTPS",
    "description" : "This post is mainly about me sharing some very useful resources and bringing light onto the cool idea behind DNS-over-HTTPS (aka. DoH). I\x27ll also share a simple setup on how to run your own DoH server to hide your DNS lookups from spying eyes.",
    "inLanguage" : "en-US",
    "author" : {
        "@type": "Person",
        "name": "Viktor Barzin",
        "image": "",
        "url": "https://viktorbarzin.me/",
        "description": "I've been digging into Programming for quite some time now. My passion for technology has grown into cyber security and automation. I love ot go offline, watch Formula 1, play cheess and go skiing."
    },
    "creator" : "Viktor Barzin",
    "publisher": {
        "@context": "http://schema.org",
        "@type": "Organization",
        "name": "Viktor Barzin",
        "sameAs": [
            "https://www.facebook.com/viktor.barzin",
            "https://github.com/ViktorBarzin",
            "https://twitter.com/ViktorBarzin",
            "https://www.linkedin.com/in/viktor-barzin/"
        ],
        "url": "https://viktorbarzin.me",
        "logo": {
          "@type": "ImageObject",
          "url": "https://viktorbarzin.me/images/profile-picture.jpeg"
        }
    },
    "accountablePerson" : "Viktor Barzin",
    "copyrightHolder" : "Viktor Barzin",
    "copyrightYear" : "29018",
    "datePublished": "2020-01-29 09:40:13 \x2b0000 UTC",
    "dateModified" : "2020-01-29 09:40:13 \x2b0000 UTC",
    "url" : "https:\/\/viktorbarzin.me\/blog\/14-dns-over-https\/",
    "wordCount" : "1689",
    "image": 	"https:\/\/viktorbarzin.me\/images\/14-dns-over-https-linkedin.png",
    "keywords" : [ "dns","dns-over-https","dns-over-tls","nginx","mozilla","cloudflare","privacy","http","dockerfile","docker","docker-compose","firefox","trr","trusted recursive resolver","Blog" ]
}
</script>

<script src="//instant.page/1.2.2" type="module" integrity="sha384-2xV8M5griQmzyiY3CDqh1dn4z3llDVqZDqzjzcY+jCBCk/a5fXJmuZ/40JJAPeoU"></script>
 <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">





<script src="/jquery-3.1.1.min.js"   integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="></script>


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">


<link rel="stylesheet" href="https://viktorbarzin.me/css/nix.css">


<link href="https://fonts.googleapis.com/css?family=Inconsolata%7COpen+Sans%7CConcert+One" rel="stylesheet">





<script async src="https://www.googletagmanager.com/gtag/js?id=UA-132992428-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-132992428-1');
</script>





    
    <script
      nonce="2726c7f26v"
      async
      src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"
    ></script>
    <script nonce="2726c7f26v">
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-9755293925267478",
        enable_page_level_ads: true,
      });
    </script>
  </head>

  <body>
    <header>
  <nav
    class="navbar navbar-default navbar-fixed-top navbar-inverse font-header"
  >
    <div class="container-fluid">
      <div class="navbar-header">
        <button
          type="button"
          class="navbar-toggle collapsed"
          data-toggle="collapse"
          data-target="#navbar-collapse-1"
          aria-expanded="false"
        >
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" id="green-terminal" href="https://viktorbarzin.me/"
          >viktor@web ~
          $</a
        >
      </div>

      
      <div class="collapse navbar-collapse" id="navbar-collapse-1">
        <ul class="nav navbar-nav navbar-right">
          <li>
            <a href="https://viktorbarzin.me/"
              >/home/viktor</a
            >
          </li>
           
          <li class="dropdown">
            
            <a href="/blog/">~/blog</a>
            
          </li>
           
          <li class="dropdown">
            
            <a href="/projects/">~/projects</a>
            
          </li>
           
          <li class="dropdown">
            
            <a href="/about-me/">~/about-me</a>
            
          </li>
          
        </ul>
      </div>
      
    </div>
    
  </nav>

  
  
  

  </header>

    <div id="kek"></div>
    <div class="container wrapper">
      <h1><a href="https://viktorbarzin.me/blog/14-dns-over-https/">14 DNS Over HTTPS</a></h1>
      <span class="post-date">Jan 29, 2020 </span>
      <div id="post-content" class="post-content">
        <h1 id="introduction">Introduction</h1>
<p>This post is mainly about me sharing some very useful resources and bringing light onto the cool idea behind DNS-over-HTTPS (aka. DoH).</p>
<p>I&rsquo;ll also share a simple setup on how to run your own DoH server to hide your DNS lookups from spying eyes.</p>
<h1 id="what-is-dns-over-https-and-why-do-i-need-it">What is DNS-over-HTTPS and why do I need it?</h1>
<p>As you know, DNS is a rather simple protocol, used for resolving domain names to IP addresses.
It&rsquo;s been around for some time now (<a href="https://en.wikipedia.org/wiki/Domain_Name_System">since 1985</a>) and it is not going anywhere anytime soon.</p>
<p>Unfortunately, the DNS queries (where you ask for an IP address of something) are <strong>not</strong> encrypted and hence all sort of bad things can happen to them - being seen (breaking <strong>confidentiality</strong>), being modified (breaking <strong>integrity</strong>) or being dropped all together (breaking <strong>availability</strong>) (read more about the <a href="https://whatis.techtarget.com/definition/Confidentiality-integrity-and-availability-CIA">CIA triad here</a>).</p>
<p>Basically it has all the issues that plain HTTP has.
To solve these issues, HTTP<strong>S</strong> was introduced which adds an entire layer of encryption magic that ensures that none of these horrible things can happen to your packets.</p>
<p>Unfortunately, the DNS protocol does <strong>not</strong> have a way to encrypt the queries (<a href="https://en.wikipedia.org/wiki/Domain_Name_System_Security_Extensions">DNSSEC</a> just provides means to authorize the response but does <strong>not</strong> hide it and it is still in plain text, hence people can analyze it).
Due to this, if someone was between you and the service you want to access (say your service provider) they could easily sniff your DNS requests and roughly figure out what and where you are doing something (<em>and of course monetize this information</em>).
In fact, if you&rsquo;ve done any network forensics, one of the first things you would look at is DNS traffic in order to gain the big picture of the traffic that has been seen.</p>
<h1 id="ways-to-encrypt-dns-traffic">Ways to encrypt DNS traffic</h1>
<p>To tackle these issues, there have been some attempts at encrypting DNS payload and in general there are 2 mainstream ways to do so - <strong>DNS-over-TLS</strong> and <strong>DNS-over-HTTPS</strong>.</p>
<h2 id="dns-over-tls-dot">DNS-over-TLS (DoT)</h2>
<p>tl;dr is that DoT is similar to how people have secured other protocols such as</p>
<ul>
<li>Web HTTP (tcp/80) -&gt; HTTPS (tcp/443)</li>
<li>Sending email SMTP (tcp/25) -&gt; SMTPS (tcp/465)</li>
<li>Receiving email IMAP (tcp/143) -&gt; IMAPS (tcp/993)</li>
<li>Now: DNS (tcp/53 or udp/53) -&gt; DoT (tcp/853)</li>
</ul>
<p>Essentially DoT is TLS packet, with DNS payload:</p>
<p><img src="/images/14-dns-over-https-2-22-30-13.png" alt=""></p>
<p>The issue with introducing a new port is that existing firewalls may block it.
This means that if clients want to resolve names they will have to downgrade to plain DNS which could allow attackers to perform downgrading attacks (example for a downgrade attack is <a href="https://blog.cloudflare.com/performing-preventing-ssl-stripping-a-plain-english-primer/">SSL Stripping</a>).</p>
<h2 id="dns-over-https-doh">DNS-over-HTTPS (DoH)</h2>
<p>DNS-over-HTTPS (DoH) on the other hand, uses regular HTTPS traffic to transport the DNS queries:</p>
<p><img src="/images/14-dns-over-https-2-21-44-28.png" alt=""></p>
<p>This is very smart because it reuses the already existing infrastructure of HTTPS (including allowed port tcp/443) to send encrypted DNS requests.
This makes it as easy as adding a route to your webserver that will handle that traffic and send it to its upstream resolver effectively anonimizing the user doing the DNS query.</p>
<p>I would <strong>strongly</strong> recommend reading <a href="https://blog.cloudflare.com/dns-encryption-explained/">this article from Cloudflare&rsquo;s blog</a> about encrypted DNS.
Basically the existence of this post is the reason why I&rsquo;m not going into details as it has been explained very well with the right amount of details and images and I&rsquo;ll definitely won&rsquo;t be able to write it in a better way.
So go now, read that blog post and come back to finish mine.</p>
<h3 id="once-youve-read-the-cloudflare-post">Once you&rsquo;ve read the cloudflare post&hellip;</h3>
<p>Open Wireshark and start filtering to see only your DNS traffic.
Open a browser and go to a website.
You&rsquo;ll be surprised the amount of DNS lookups you make just to <strong>open</strong> any site.</p>
<p>The cloudflare blog post mentions that there are ways to configure all of your devices to use DoH and a public DoH provider and solve your issue with the unencrypted DNS traffic.
To do so, you effectively set your DNS lookups to use a particular service provider e.g Cloudflare or Google.</p>
<p>However, <strong>do you trust them?</strong>
This would mean that they would know <strong>all</strong> of your lookups, including the client you are using to do them, which, if you are a privacy-concerned person like me, may not sound like the best idea.
Surely, much better than using no encryption at all but we can do better.</p>
<h1 id="hosting-a-dns-over-https-server">Hosting a DNS-over-HTTPS server</h1>
<p>Parsing the HTTP payload for the DNS data and then doing the appropriate query manually might be a painful process to do in a secure and reliable manner.
Luckily, somebody has already done such a service and it&rsquo;s under the MIT license so you can use it and self host it!</p>
<p><a href="https://github.com/m13253/dns-over-https">This is a simple DNS-over-HTTPS server</a> written in go, that complies with the respective RFCs and is quite easy to setup.
If you want the <strong>full</strong> details of setting up the DoH server, with an upstream resolver, a frontend nginx server and what not, you can have a read at <a href="https://www.bentasker.co.uk/documentation/linux/407-building-and-running-your-own-dns-over-https-server">this</a> rather long post.</p>
<p>In the end of the day, what you need to do is compile and run the DoH server on some port, setup an HTTP<strong>S</strong> nginx site with a path (by convention <code>/dns-query</code>) that is forwarded to the DoH server and finally (optionally) you can setup your own DNS resolver or use someoneelse&rsquo;s (This way they will still know you do these queries, but will be unable to identify the end device that requests them so if you&rsquo;re multiple people using the DoH resolver, it&rsquo;ll be very hard to determine who is querying what)</p>
<p>What follows is a brief description of what I did to setup a DoH server in my environment so you can follow the steps to setup one on your own.</p>
<h1 id="setting-up-doh-in-my-environment">Setting up DoH in my environment</h1>
<p>In my environment, most stuff run in docker containers so the first thing I did was to create a <code>Dockerfile</code> that sets up the dns-over-https server:</p>
<pre><code>FROM golang

WORKDIR /
COPY doh-server /doh-server
COPY doh-server.conf /doh-server.conf

CMD [&quot;/doh-server&quot;]
</code></pre>
<p>I had the <code>doh-server</code> binary already compiled locally.
It is a better idea to compile the <code>doh-server</code> code inside the container, but since my containers run on <code>x86</code> architecture it&rsquo;s fine to just copy over the binary.</p>
<p>To compile the binary run</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">make
</code></pre></div><p>inside the root directory of the project (where the <code>Makefile</code> is).</p>
<p>This creates a bunch of files as well as the <code>doh-server</code> binary which is inside the <code>doh-server</code> directory.</p>
<p>Another file you will need is the <code>doh-server.conf</code> config where we specify 2 important things -</p>
<ul>
<li>Port to listen onto (the DoH server is still an HTTP server)</li>
<li>The upstream DNS resolver that we are going to use</li>
</ul>
<p>My config looks like this (upstream DNS server IP intentionally hidden, you can use <code>1.1.1.1</code> or your own DNS service like I do)</p>
<pre><code># HTTP listen port
listen = [
    &quot;0.0.0.0:8053&quot;,
]

# TLS certification file
# If left empty, plain-text HTTP will be used.
# You are recommended to leave empty and to use a server load balancer (e.g.
# Caddy, Nginx) and set up TLS there, because this program does not do OCSP
# Stapling, which is necessary for client bootstrapping in a network
# environment with completely no traditional DNS service.
cert = &quot;&quot;

# TLS private key file
key = &quot;&quot;

# HTTP path for resolve application
path = &quot;/dns-query&quot;

# Upstream DNS resolver
# If multiple servers are specified, a random one will be chosen each time.
upstream = [
    &quot;&lt;some DNS service that I own&gt;:53&quot;
]

# Upstream timeout
timeout = 10

# Number of tries if upstream DNS fails
tries = 3

# Only use TCP for DNS query
tcp_only = false

# Enable logging
verbose = true

# Enable log IP from HTTPS-reverse proxy header: X-Forwarded-For or X-Real-IP
# Note: http uri/useragent log cannot be controlled by this config
log_guessed_client_ip = false
</code></pre>
<p>With that up and running, all is left is to setup an HTTPS nginx web server that will forward requests to the DoH container.
I have automated the bootstrapping process of the nginx container and the result config (with trimmed optimizations for simplicity) looks like this:</p>
<pre><code>events { }

http {
    server {
        server_name viktorbarzin.me;
        listen 443 ssl;
        ssl_certificate /etc/fullchain.pem;
        ssl_certificate_key /etc/privkey.pem;

        location / {
            proxy_pass http://dns-over-https-server:8053;
        }
    }
}
</code></pre>
<p>Note that this container has mounted the <code>fullchain.pem</code> and <code>privkey.pem</code> in <code>/etc</code>.
I&rsquo;d recommend getting a valid SSL certificate to avoid invalid certificate issues.</p>
<p>The <code>docker-compose.yml</code> file has:</p>
<pre><code>version: '3.1'
services:
    nginx:
        image: nginx:latest
        container_name: dns-over-https-server-nginx
        depends_on:
            - proxied_service
        volumes:
            - ./nginx.conf:/etc/nginx/nginx.conf:ro
            - ./fullchain.pem:/etc/fullchain.pem:ro
            - ./privkey.pem:/etc/privkey.pem:ro
        networks:
            dns-over-https-server-network:
        ports:
            - 54285:443
    proxied_service:
        build:
            context: /ansible_files/dns-over-https-server/dns-over-https-server
            dockerfile: Dockerfile
        container_name: dns-over-https-server
        expose:
            - 8053
        networks:
            dns-over-https-server-network:
                aliases:
                    - dns-over-https-server
networks:
    dns-over-https-server-network:
</code></pre>
<p>With that setup up and running, we can now start serving DNS over HTTPS!</p>
<h1 id="testing-the-setup">Testing the setup</h1>
<p>The <a href="https://blog.cloudflare.com/dns-encryption-explained/#deployment-of-dot-and-doh">Cloudflare post</a> I mentioned earlier has a section on how to setup DoH on your clients.</p>
<p>I tested the setup on latest Firefox (72.0.2) by going to <code>about:config</code>, then searched for <code>trr</code> (Trusted Recursive Resolver) and set <code>network.trr.mode = 2</code> and <code>network.trr.uri = https://dns.viktorbarzin.me/dns-query</code>.</p>
<p>There&rsquo;s 2 things to note about these 2 settings - firstly, the trr modes are explained in the <a href="https://wiki.mozilla.org/Trusted_Recursive_Resolver#network.trr.mode">mozilla wiki</a>.
Essentially <code>2</code> is <em>opportunistic</em> which means that it will try to use DoH if possible, but if the server is unavailable it will fallback to standard DNS.
<code>3</code> is strict, which results in DNS errors if the server is unavailable for any reason (resistant to downgrading attacks) and <code>0</code> and <code>5</code> is not to use <code>trr</code> at all.</p>
<p>The simple test you can do to see that everything is working properly and you are not leaking your DNS queries is to set the mode to <code>2</code> and sniff you DNS traffic in Wireshark - it will be empty despite the fact that you are looking up domains when you browse the internet.
If you set the mode to <code>0</code> or <code>5</code>, you will instantly see all the DNS traffic generated by ads and what have you.</p>
<h1 id="conclusion">Conclusion</h1>
<p>I hope that you enjoyed this post as much as I enjoyed writing it.
You can share your thoughts in the comments section and share it with your friends to let them know about DNS-over-HTTPS!</p>

      </div>
      
      <div class="post-comments">
        <div id="disqus_thread"></div>

<script nonce="2726c7f26v" type="application/javascript">
    var disqus_config = function () {
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "viktorbarzin" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

        
      </div>
      
      <div class="push"></div>
    </div>
    <script>
  var PageScrollIndicator = PageScrollIndicator || {};

  PageScrollIndicator.createProgressBar = function (
    progressBarLocation,
    contentToTrack
  ) {
    
    var $progressContElement = $("<div id='progress-cont'></div>");

    
    var $progressBarElement = $("<div id='progress-bar'></div>");
    $progressBarElement.css("width", "0%");

    $progressContElement.append($progressBarElement);

    var $locationObject = $(progressBarLocation);
    $locationObject.prepend($progressContElement);

    
    
    $(window).scroll(function (e) {
      var pageHeight = $(window).height();
      var $container = $(contentToTrack);

      
      var adjustedHeight = $container.innerHeight() - pageHeight;
      var progress = ($(window).scrollTop() / adjustedHeight) * 100;
      $progressBarElement.css("width", progress + "%");
    });
  };
</script>

<style>
  #progress-cont {
    height: 5px;
    position: fixed;
    width: 100%;
    top: 0px;
    left: 0px;
  }

  #progress-bar {
    height: 100%;
    background-color: #48a868;
  }
</style>
 <footer class="footer text-center">
<p>Copyright &copy; 2020 Viktor Barzin
<span class="credit">
	
	
	
	
    
</span>
</p>
</footer>

    <script>
      
      PageScrollIndicator.createProgressBar(
        "#navbar-collapse-1",
        
        "#post-content"
      );
    </script>
  </body>
</html>
